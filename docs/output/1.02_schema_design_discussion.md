# 1.02 Schema Design Discussion

**Date:** December 10, 2025
**Status:** Awaiting user confirmation before schema changes

---

## Quick Clarifications

### Cognito

Yes, AWS Cognito is the auth service. It handles user identity (sign up, sign in, MFA, password reset). NextAuth.js v5 wraps it for session management in Next.js.

### FeeScheduleItem

Yes, for billing/insurance. It's a lookup table mapping CPT codes (like 97810 for acupuncture) to your fees. Used when generating superbills. Clinics set their own fee schedule.

**Note:** We should add default seed data so practitioners don't have to set this up from scratch.

### isActive on Patient

Just soft-delete. If a patient stops coming, you don't delete their records (HIPAA retention), you mark `isActive = false` so they don't clutter the active patient list.

### practitionerNotes on Appointment

Private notes only you see (e.g., "patient mentioned job stress, follow up next visit"). Not part of official SOAP note, not on superbill. Think of it as your reminder sticky note.

### cancellationReason

Fair pushback. It's useful for patterns (seeing why patients cancel) but not essential. Two options:

1. Keep it simple: just track `CANCELLED` status, no reason
2. Keep the optional field for those who want it

**Recommendation:** Keep it optional - it's one nullable field that adds value without forcing workflows.

---

## Medical Profile Versioning (Layer 1)

### The Challenge

- Need to see CURRENT state at a glance (during appointment)
- Need to see HISTORY (when did this change? which visit?)
- Applies to: PMH, FH, SH, Medications, Allergies, etc.
- These don't change often, but when they do, it matters

### Schema Approach: Hybrid (JSON current + History table)

```prisma
model Patient {
  // Layer 1 - Current state (for fast reads)
  medicalProfile Json  // Combined all sections
}
```

**Patient.medicalProfile structure:**

```json
{
  "pastMedicalHistory": {
    "conditions": ["Hypertension (2018)", "Diabetes Type 2 (2020)"],
    "surgeries": ["Appendectomy (2015)"],
    "lastUpdated": "2024-03-15",
    "lastUpdatedVisitId": "visit_456"
  },
  "medications": {
    "current": [
      { "name": "Metformin", "dose": "500mg", "frequency": "2x daily" }
    ],
    "significantPast": [
      { "name": "Accutane", "period": "2014-2015",
        "notes": "Watch liver, joints, skin" }
    ],
    "lastUpdated": "2024-01-10"
  },
  "allergies": {
    "items": ["Penicillin (hives)", "Shellfish (anaphylaxis)"],
    "lastUpdated": "2023-06-20"
  }
}
```

```prisma
model MedicalProfileHistory {
  id          String   @id @default(cuid())
  patientId   String
  visitId     String?   // NULL if updated outside visit
  section     String    // "medications", "pastMedicalHistory", etc.
  changeType  String    // "added", "removed", "modified"
  changeDescription String // "Added Metformin 500mg"
  previousValue Json?   // Snapshot before
  newValue     Json     // Snapshot after
  changedBy    String   // practitionerId
  changedAt    DateTime @default(now())

  patient     Patient  @relation(fields: [patientId], references: [id])
}
```

### UI: Clean View (Default - during appointment)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MEDICAL PROFILE                                    [View History]â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                   â”‚
â”‚  Past Medical History                               Updated Mar 15â”‚
â”‚  â”œâ”€â”€ Hypertension (2018)                                          â”‚
â”‚  â”œâ”€â”€ Diabetes Type 2 (2020)                                       â”‚
â”‚  â””â”€â”€ Appendectomy (2015)                                          â”‚
â”‚                                                                   â”‚
â”‚  Medications                                        Updated Jan 10â”‚
â”‚  â”œâ”€â”€ Current: Metformin 500mg 2x daily                            â”‚
â”‚  â””â”€â”€ âš ï¸ Significant: Accutane (2014-15) - watch liver/joints      â”‚
â”‚                                                                   â”‚
â”‚  Allergies                                          Updated Jun 20â”‚
â”‚  â”œâ”€â”€ âš ï¸ Penicillin (hives)                                        â”‚
â”‚  â””â”€â”€ âš ï¸ Shellfish (anaphylaxis)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Clean, scannable
- "Updated X" shows recency at a glance
- âš ï¸ highlights critical items (allergies, significant meds)
- One tap on section to edit

### UI: History View (Expanded)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MEDICAL PROFILE HISTORY                            [Close]       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                   â”‚
â”‚  Filter: [All Sections â–¾]  [All Time â–¾]                           â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Mar 15, 2024 â€¢ Visit #12                                   â”‚  â”‚
â”‚  â”‚  Past Medical History                                       â”‚  â”‚
â”‚  â”‚  + Added: Diabetes Type 2 (2020)                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Jan 10, 2024 â€¢ Visit #10                                   â”‚  â”‚
â”‚  â”‚  Medications                                                â”‚  â”‚
â”‚  â”‚  + Added: Metformin 500mg                                   â”‚  â”‚
â”‚  â”‚  - Removed: Lisinopril 10mg                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Jun 20, 2023 â€¢ Visit #5                                    â”‚  â”‚
â”‚  â”‚  Allergies                                                  â”‚  â”‚
â”‚  â”‚  + Added: Penicillin (hives)                                â”‚  â”‚
â”‚  â”‚  Notes: "Discovered during dental procedure"                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Editing Flow (Minimal friction)

1. Tap "Medications" section
2. Edit modal opens with current list
3. Add/remove/modify
4. Save â†’ MedicalProfileHistory record auto-created

If during a visit: visitId auto-linked
If outside visit: visitId = NULL, just tracks the change

**Practitioner doesn't "manage" history - it just happens.**

---

## Medication Tracking: The Accutane Use Case

For medications with long-term implications (like Accutane):

```json
{
  "medications": {
    "current": [
      { "name": "Metformin", "dose": "500mg", "frequency": "2x daily" }
    ],
    "significantPast": [
      {
        "name": "Accutane (isotretinoin)",
        "period": "2014-2015",
        "isSignificant": true,
        "notes": "Watch for: liver function, joint issues, dry skin.
                  Patient reports occasional joint stiffness since."
      }
    ]
  }
}
```

**UI Behavior:**

- "Significant Past" section always visible at top of med list
- Yellow/orange highlight or â­ icon
- Quick-view notes on hover/tap
- Every visit, practitioner sees this reminder

---

## PointProtocol Side Logic

### How It Works

**PointSide Enum (Already in schema):**

- `BILATERAL` â†’ Fixed: Both sides
- `LEFT` â†’ Fixed: Left only
- `RIGHT` â†’ Fixed: Right only
- `CENTER` â†’ Fixed: Midline (DU, RN, Yintang)
- `CONTRALATERAL` â†’ Dynamic: Opposite side of selected
- `IPSILATERAL` â†’ Dynamic: Same side as selected

**Rule:** LEFT, RIGHT, CENTER, BILATERAL = Fixed
**Rule:** CONTRALATERAL, IPSILATERAL = Dynamic

### Example: Shoulder Pain Protocol

**ProtocolPoint entries:**

| Point | Side          | Type                    |
| ----- | ------------- | ----------------------- |
| LI4   | CONTRALATERAL | Dynamic                 |
| LI11  | IPSILATERAL   | Dynamic                 |
| GB21  | IPSILATERAL   | Dynamic                 |
| SI3   | CONTRALATERAL | Dynamic                 |
| DU14  | CENTER        | Fixed (stays CENTER)    |
| LI15  | BILATERAL     | Fixed (stays BILATERAL) |

**When applying protocol, practitioner selects: "RIGHT shoulder pain"**

**Resolution:**

| Point | Original      | Resolved              |
| ----- | ------------- | --------------------- |
| LI4   | CONTRALATERAL | LEFT                  |
| LI11  | IPSILATERAL   | RIGHT                 |
| GB21  | IPSILATERAL   | RIGHT                 |
| SI3   | CONTRALATERAL | LEFT                  |
| DU14  | CENTER        | CENTER (unchanged)    |
| LI15  | BILATERAL     | BILATERAL (unchanged) |

### Schema Change

**REMOVE** `sideType` from PointProtocol - it's redundant since we can determine dynamism from the ProtocolPoints.

### "Flip All Sides" Feature

UI: Protocol application dialog

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Apply: Shoulder Pain Protocol                                    â”‚
â”‚                                                                   â”‚
â”‚  Affected side: [RIGHT â–¼]                                         â”‚
â”‚                                                                   â”‚
â”‚  [ ] Mirror all fixed sides                                       â”‚
â”‚      (Flip LEFTâ†”RIGHT for non-dynamic points)                     â”‚
â”‚                                                                   â”‚
â”‚  Preview:                                                         â”‚
â”‚  LI4   â†’ LEFT (contra)                                            â”‚
â”‚  LI11  â†’ RIGHT (ipsi)                                             â”‚
â”‚  DU14  â†’ CENTER (fixed)                                           â”‚
â”‚  LI15  â†’ BILATERAL (fixed)                                        â”‚
â”‚                                                                   â”‚
â”‚  [Cancel]                              [Apply Protocol]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Template Cursor Positioning

### Approach: Use "|" as cursor marker (simple)

**Template.content stored as:**

```
Protruding? |
Does it retract? |
Is it bleeding? |
Pain score (0-10)? |
```

"|" marks where cursor lands
Down arrow: find next "|", place cursor there
Up arrow: find previous line end, place cursor there

### Navigation Flow

**Initial template expansion:**

```
Protruding? |                      â† cursor here
Does it retract? |
Is it bleeding? |
Pain score (0-10)? |
```

**Step 1: Type "Yes, grade 2"**

```
Protruding? Yes, grade 2|          â† cursor at end of what you typed
Does it retract? |
Is it bleeding? |
Pain score (0-10)? |
```

**Step 2: Press â†“ (Down arrow)**

```
Protruding? Yes, grade 2
Does it retract? |                 â† cursor jumps here (marker removed)
Is it bleeding? |
Pain score (0-10)? |
```

**Step 3: Type "No" then press â†“**

```
Protruding? Yes, grade 2
Does it retract? No
Is it bleeding? |                  â† cursor here
Pain score (0-10)? |
```

**Step 4: Press â†‘ (Up arrow) - GOING BACK**

```
Protruding? Yes, grade 2
Does it retract? No|               â† cursor at END of line, not at |
Is it bleeding? |
Pain score (0-10)? |
```

**Step 5: Press â†‘ again**

```
Protruding? Yes, grade 2|          â† cursor at END of "grade 2"
Does it retract? No
Is it bleeding? |
Pain score (0-10)? |
```

Now you can continue typing: "Yes, grade 2, external"

### Implementation Logic

Track "answer lines" - lines that had a | marker originally

- â†“ Down: Jump to next | marker (or next answer line end if filled)
- â†‘ Up: Jump to END of previous answer line

Once a line has content, | is replaced with EOL as the target.

---

## TreatmentPackage: Clinic vs Practitioner Level

### Option B: Practitioner-specific packages (Recommended)

```prisma
model TreatmentPackage {
  clinicId        String
  practitionerId  String?  // NULL = clinic-wide, set = specific practitioner
  // ...
}

model PatientPackage {
  // ...existing fields...
  restrictToPractitionerId  String?  // NULL = any, set = specific
}
```

### Scenarios

1. **Solo practice (your case):**

   - Packages are clinic-level
   - You're the only practitioner anyway
   - Works exactly like simple version
2. **Multi-practitioner, shared packages:**

   - "Clinic 10-pack" - patient can see anyone
   - restrictToPractitionerId = NULL
3. **Multi-practitioner, practitioner-specific:**

   - "Dr. Smith's 10-pack" - only valid with Dr. Smith
   - restrictToPractitionerId = Dr. Smith's ID
   - Common when practitioners are independent contractors

### Patient Package View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Active Packages:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  10-Treatment Package (Clinic)                            â”‚    â”‚
â”‚  â”‚  6 of 10 remaining â€¢ Expires: Mar 2025                    â”‚    â”‚
â”‚  â”‚  Valid with: Any practitioner                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Dr. Chen's Specialty Package                             â”‚    â”‚
â”‚  â”‚  3 of 5 remaining â€¢ No expiration                         â”‚    â”‚
â”‚  â”‚  Valid with: Dr. Chen only                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Payment Methods: Full Design

### PaymentMethod Enum

```prisma
enum PaymentMethod {
  CARD              // Stripe - credit/debit (Stripe tells us which)
  HSA               // Health Savings Account (manual tag or Stripe detection)
  FSA               // Flexible Spending Account
  CASH              // In-person cash
  CHECK             // Paper check
  INSURANCE_PAYOUT  // Reimbursement from insurance
  PACKAGE_CREDIT    // From pre-paid package
  OTHER             // Catch-all
}
```

### Payment + PaymentTransaction Model

```prisma
model Payment {
  id              String   @id @default(cuid())
  appointmentId   String   @unique

  amountDue       Decimal  @db.Decimal(10, 2)
  status          PaymentStatus @default(PENDING)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  appointment     Appointment @relation(...)
  transactions    PaymentTransaction[]
}

enum PaymentStatus {
  PENDING         // Not yet paid
  PARTIAL         // Some paid, balance remaining
  PAID            // Fully paid
  REFUNDED        // Money returned
  WRITTEN_OFF     // Uncollectable, forgiven
}

model PaymentTransaction {
  id              String   @id @default(cuid())
  paymentId       String

  method          PaymentMethod
  amount          Decimal  @db.Decimal(10, 2)

  // For card payments (Stripe)
  stripePaymentIntentId  String?
  stripeChargeId         String?
  cardLast4              String?
  cardBrand              String?

  // For package credits
  patientPackageId       String?
  creditsUsed            Int?

  // For checks
  checkNumber            String?

  // For insurance payouts
  insuranceClaimId       String?
  insuranceEraId         String?
  isAutoPosted           Boolean @default(false)

  notes           String?
  transactedAt    DateTime @default(now())

  payment         Payment  @relation(...)
}
```

### Why Payment + Transactions vs Multiple Payments?

| Aspect             | Multiple Payments  | Payment + Transactions   |
| ------------------ | ------------------ | ------------------------ |
| Schema simplicity  | Simpler            | More complex             |
| Status tracking    | Calculated         | Explicit field           |
| Refunds            | New Payment record | New Transaction (clean)  |
| Partial refunds    | Awkward            | Negative transaction     |
| Insurance later    | New Payment record | New Transaction          |
| "Total paid" query | SUM(amount)        | SUM(transactions.amount) |

**Recommendation:** Payment + Transactions - slightly more schema but cleaner operations.

### Split Payment Example

Visit costs $150, patient has 1 credit from package, pays $50 cash:

```
Payment {
  amountDue: 150.00
  status: PAID
  transactions: [
    { method: PACKAGE_CREDIT, amount: 100.00, creditsUsed: 1 },
    { method: CASH, amount: 50.00 }
  ]
}
```

### Insurance + Copay Example

```
Payment { amountDue: 150.00, status: PAID }
  â””â”€â”€ Transaction { method: CARD, amount: 30.00 }      // copay at visit
  â””â”€â”€ Transaction { method: INSURANCE_PAYOUT, amount: 120.00,
        insuranceClaimId: "CLM-12345" }                // later
```

### HSA/FSA Handling

HSA and FSA cards work through Stripe like regular cards:

- Patient adds their HSA/FSA card in Stripe
- Stripe processes it
- We record method as HSA or FSA for reporting

**Recommendation:** Default to generic "Card" from Stripe, let practitioner override to HSA/FSA if they know.

### Credit Card vs Debit Card

Stripe tells us via `payment_method_details.card.funding` which returns `"credit"`, `"debit"`, or `"prepaid"`. We can use this for reporting if needed.

---

## Insurance Payout Automation (Premium Tier)

### How It Works in the Industry

1. **CLAIM SUBMISSION (837)**

   - Clinic â†’ Clearinghouse â†’ Insurance
2. **PAYMENT + REMITTANCE (835/ERA)**

   - Insurance â†’ Clearinghouse â†’ Clinic
   - The 835/ERA file contains: Claim ID, Amount paid, Adjustments, Patient responsibility

### Automation Capability

**YES - Premium tier can auto-post payments:**

1. Clearinghouse receives 835/ERA from insurance
2. Our system polls clearinghouse API (or receives webhook)
3. Match ERA to our Superbill via claim reference
4. Auto-create PaymentTransaction with method: INSURANCE_PAYOUT
5. Update Payment.status if fully paid
6. Flag denials/adjustments for practitioner review

**Practitioner sees notification:** "Insurance paid $120 for Visit #45"
**No manual entry required.**

### Tier Comparison

| Feature          | Basic Tier           | Premium Tier                 |
| ---------------- | -------------------- | ---------------------------- |
| Superbill        | Generate PDF         | Generate PDF                 |
| Submission       | Patient self-submits | Electronic via clearinghouse |
| Payment tracking | Manual recording     | Auto-posted from ERA         |
| Denials          | N/A                  | Flagged with reason codes    |

### Schema Additions

```prisma
model PaymentTransaction {
  // ...existing fields...
  insuranceEraId    String?   // 835/ERA reference
  adjustmentCodes   Json?     // CARC/RARC codes if partial/denied
  isAutoPosted      Boolean @default(false)
}

model Superbill {
  // ...existing fields...
  clearinghouseClaimId  String?  // For matching ERA back to our records
}
```

**Sources:**

- [CMS: Health Care Payment and Remittance Advice](https://www.cms.gov/priorities/key-initiatives/burden-reduction/administrative-simplification/transactions/health-care-payment-remittance-advice-electronic-funds-transfer)
- [UHC: EDI 835 Electronic Remittance Advice](https://www.uhcprovider.com/en/resource-library/edi/edi-835.html)

---

## CRM-Style Notes (Rapport Building)

### The Need

"Patient visiting daughter in Arizona in November"
"Loves hiking, ask about trip to Yosemite"
"Prefers afternoon appointments, works nights"
"Sensitive to needles - extra reassurance needed"

This isn't clinical data. It's relationship data.
Should persist, grow over time, be visible at appointments.

### Schema: PatientNote table

```prisma
model PatientNote {
  id          String   @id @default(cuid())
  patientId   String
  visitId     String?  // Optional link to when noted

  category    NoteCategory
  content     String
  isPinned    Boolean @default(false)  // Show at top always

  createdAt   DateTime @default(now())
  createdBy   String  // practitionerId

  patient     Patient @relation(...)
}

enum NoteCategory {
  PERSONAL            // Life stuff (family, hobbies, travel)
  PREFERENCE          // Scheduling, communication preferences
  CLINICAL_REMINDER   // Non-condition clinical notes
}
```

### UI: Patient Profile

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JOHN SMITH                                    [Edit] [Schedule] â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                   â”‚
â”‚  ğŸ“Œ PINNED NOTES                                                  â”‚
â”‚  â”œâ”€â”€ Sensitive to needles - use thinner gauge, extra reassurance  â”‚
â”‚  â””â”€â”€ Prefers afternoon appointments (works nights)                â”‚
â”‚                                                                   â”‚
â”‚  ğŸ’¬ RAPPORT NOTES                               [+ Add Note]      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Nov 15, 2024                                              â”‚  â”‚
â”‚  â”‚  Visiting daughter Sarah in Arizona for Thanksgiving.       â”‚  â”‚
â”‚  â”‚  Excited about hiking Sedona.                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Sep 20, 2024                                              â”‚  â”‚
â”‚  â”‚  Just got promoted at work. More stress but happy.          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### UI: During Appointment (Quick View)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JOHN SMITH - Quick View                                          â”‚
â”‚                                                                   â”‚
â”‚  ğŸ“Œ Needle-sensitive, use thinner gauge                           â”‚
â”‚  ğŸ“Œ Prefers afternoons                                            â”‚
â”‚                                                                   â”‚
â”‚  ğŸ’¬ Recent: "Visiting daughter in Arizona for Thanksgiving"       â”‚
â”‚     â†’ Ask about the trip!                                         â”‚
â”‚                                                                   â”‚
â”‚  [+ Quick note]                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Separate from practitionerNotes on Appointment** (those are private, single-visit clinical reminders - different purpose).

---

## Unified Data Entry: Single Text â†’ Multiple Tables

### The Problem

**Current (Bad) Flow:**

1. Select chief complaints from list (click, click, click)
2. Enter pain score in separate field (type)
3. Enter today's note for condition (type)
4. Enter full subjective narrative (type again, repeating info)

= 4 separate entry points, duplicate information

### Proposed: Single Text Entry with Smart Recognition

Practitioner just WRITES their subjective note naturally:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SUBJECTIVE                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                   â”‚
â”‚  Low back pain 7/10, worse x3 days after lifting heavy box.       â”‚
â”‚  Radiates to left glute, no numbness. Better with walking,        â”‚
â”‚  worse with sitting. Also reports mild neck tension from          â”‚
â”‚  computer work 4/10.                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**System AUTOMATICALLY extracts:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Recognized Conditions:                                           â”‚
â”‚                                                                   â”‚
â”‚  âœ“ Low back pain          7/10    [Primary]  â† auto-linked        â”‚
â”‚    â””â”€â”€ Matches existing PatientCondition "Low back pain"          â”‚
â”‚    â””â”€â”€ Pain score 7 auto-recorded to ConditionMeasurement         â”‚
â”‚                                                                   â”‚
â”‚  ? Neck tension           4/10    [Add as condition?]             â”‚
â”‚    â””â”€â”€ Not in problem list - offer to add                         â”‚
â”‚                                                                   â”‚
â”‚  [Confirm] [Edit]                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**One text entry â†’ Chief complaints linked â†’ VAS scores recorded**

### How Recognition Works

Pattern matching against patient's existing conditions:

```
Patient has: ["Low back pain", "Tinnitus", "Insomnia"]

Text: "Low back pain 7/10, worse x3 days..."
       ^^^^^^^^^^^^^^ ^^^^
       matches        VAS score pattern
       condition

Text: "neck tension 4/10"
       ^^^^^^^^^^^^ ^^^^
       no match     VAS score
       â†’ suggest adding new condition

VAS patterns: "7/10", "7 out of 10", "pain 7", "VAS 7"
```

### Data Flow

```
Practitioner types:
"LBP 7/10, flared after lifting"
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Visit.subjective    â”‚  â† Full text stored (medical-legal record)
â”‚ {                   â”‚
â”‚   raw: "LBP 7/10...",
â”‚   recognized: {...} â”‚
â”‚ }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼ (auto-generated)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VisitChiefComplaint â”‚  â† Link created automatically
â”‚ visitId + conditionId
â”‚ isPrimary: true     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼ (auto-generated)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConditionMeasurementâ”‚  â† VAS score recorded automatically
â”‚ metricName: "vas"   â”‚
â”‚ value: "7"          â”‚
â”‚ visitId: this visit â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Practitioner typed ONCE. Three tables updated.
```

---

## Unified Plan/TreatmentPoints Entry

### Same Philosophy: Type naturally, system recognizes

**Practitioner types:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PLAN                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                   â”‚
â”‚  Tx principle: Move Qi and Blood, relieve pain                    â”‚
â”‚                                                                   â”‚
â”‚  Acupuncture: /shoulder-pain-protocol R                           â”‚
â”‚  + GB34 B, BL40 L, Huatuojiaji L3-L5 B                            â”‚
â”‚                                                                   â”‚
â”‚  Cupping on upper back 10 min                                     â”‚
â”‚  Lifestyle: Ice 20 min 3x daily, avoid lifting >10 lbs            â”‚
â”‚  F/U: 1 week                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Recognition in Action

**"/shoulder-pain-protocol R"**

- Protocol trigger + Side selection (R = Right affected side)
- â†’ Expands to all protocol points
- â†’ Dynamic points resolved
- â†’ Fixed points stay as defined

**"GB34 B, BL40 L, Huatuojiaji L3-L5 B"**

- B = Bilateral, L = Left, R = Right, C = Center

### Real-time Recognition UI

As practitioner types "GB34 B":

```
Acupuncture: /shoulder-pain-protocol R
+ GB34 B â† [GB34 Yanglingquan - Bilateral âœ“]
     â””â”€â”€ Subtle inline confirmation, not a popup

If typo: "GB3r B" â†’ [Did you mean GB34? â–¾]
```

### Technique Handling

Default: EVEN (most common)

Override syntax:

- "LI4 B+" â†’ Tonifying
- "LI4 B-" â†’ Reducing
- "LI4 B" â†’ Even (default)

### Practitioner's Typical Flow

Most visits, practitioner uses similar points. System learns:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Acupuncture: |                                                   â”‚
â”‚                                                                   â”‚
â”‚  Recent protocols:        Recent points for LBP:                  â”‚
â”‚  â€¢ /four-gates           â€¢ BL40, BL60, GB34                       â”‚
â”‚  â€¢ /shoulder-pain        â€¢ Huatuojiaji                            â”‚
â”‚  â€¢ /lbp-basic            â€¢ BL23, BL25                             â”‚
â”‚                                                                   â”‚
â”‚  [Tap to insert] or just start typing                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

One tap on "/lbp-basic" â†’ protocol expands
Add "BL17 B" â†’ one additional point
Done. 12 points entered in 5 seconds.

---

## VAS Score Automation & Condition Status Updates

### The Goal: No manual status management

Currently: Practitioner manually sets ACTIVE â†’ IMPROVING â†’ RESOLVED
Goal: System suggests status based on data, practitioner confirms

### Data Sources for VAS

1. **During visit** (from Subjective text recognition)

   - "LBP 7/10" â†’ ConditionMeasurement { vas: 7, visitId: X }
2. **Patient follow-up SMS** (Day 3, Day 5)

   - System: "How is your back pain today? Reply 0-10"
   - Patient: "4"
   - â†’ ConditionMeasurement { vas: 4, visitId: null, source: SMS }
3. **Pre-visit intake** (patient fills form before appointment)

   - â†’ ConditionMeasurement { vas: 5, visitId: upcoming }

### Schema Additions

```prisma
model ConditionMeasurement {
  // ...existing fields...
  source    MeasurementSource  // VISIT, SMS_FOLLOWUP, INTAKE, MANUAL
}

enum MeasurementSource {
  VISIT
  SMS_FOLLOWUP
  INTAKE
  MANUAL
}

model FollowUpRequest {
  id              String   @id @default(cuid())
  patientId       String
  conditionId     String
  visitId         String     // Which visit triggered this
  scheduledFor    DateTime   // When to send
  sentAt          DateTime?
  responseValue   String?    // "4"
  respondedAt     DateTime?
  status          FollowUpStatus // PENDING, SENT, RESPONDED, EXPIRED

  patient         Patient @relation(...)
  condition       PatientCondition @relation(...)
}

enum FollowUpStatus {
  PENDING
  SENT
  RESPONDED
  EXPIRED
}
```

### Automatic Status Suggestions

Based on VAS trend over last N measurements:

| Measurements    | Trend      | Suggestion |
| --------------- | ---------- | ---------- |
| [8, 7, 5, 4, 3] | Decreasing | IMPROVING  |
| [5, 5, 4, 5, 5] | Flat       | STABLE     |
| [4, 5, 6, 7, 8] | Increasing | WORSENING  |
| [3, 2, 1, 1, 0] | Near zero  | RESOLVED?  |

### UX: How It Appears

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONDITIONS                                                       â”‚
â”‚                                                                   â”‚
â”‚  Low back pain                                                    â”‚
â”‚  Status: ACTIVE â†’ ğŸ’¡ Suggest: IMPROVING                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  VAS Trend (last 5 measurements)        â”‚                      â”‚
â”‚  â”‚  8 â”€â”                                   â”‚                      â”‚
â”‚  â”‚  7  â””â”€â”                                 â”‚                      â”‚
â”‚  â”‚  5    â””â”€â”€â”€â”                             â”‚                      â”‚
â”‚  â”‚  4        â””â”€â”                           â”‚                      â”‚
â”‚  â”‚  3          â””â”€â”€â— Today                  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚  [Accept: IMPROVING]  [Keep: ACTIVE]  [Other...]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- System suggests based on trend
- One tap to accept suggestion
- Or override if practitioner disagrees
- No manual management unless they want it

### Algorithm (Simple heuristic)

```javascript
// Last N measurements (default 5)
const recent = measurements.slice(-5)

// Calculate trend
const first = avg(recent.slice(0, 2))
const last = avg(recent.slice(-2))
const diff = last - first

if (last <= 1) return 'RESOLVED'     // Near zero
if (diff <= -2) return 'IMPROVING'   // Dropped 2+ points
if (diff >= 2) return 'WORSENING'    // Increased 2+ points
return 'STABLE'                       // Flat-ish
```

---

## Schema Changes Summary

### Confirmed Changes

1. **REMOVE** `ProtocolSideType` enum from PointProtocol

   - Side logic determined by ProtocolPoint.side values
2. **ADD** `practitionerId` to TreatmentPackage

   - NULL = clinic-wide, set = practitioner-specific
3. **ADD** `restrictToPractitionerId` to PatientPackage

   - For practitioner-specific credit usage
4. **REPLACE** Payment model with Payment + PaymentTransaction

   - ADD PaymentMethod enum
   - ADD PaymentStatus enum
   - Support split payments, multiple methods
5. **ADD** MedicalProfileHistory table

   - Track changes to Layer 1 JSON fields
   - Links to visitId when changes during visit
6. **ADD** PatientNote table (CRM notes)

   - NoteCategory enum (PERSONAL, PREFERENCE, CLINICAL_REMINDER)
   - isPinned for important reminders
7. **ADD** `source` field to ConditionMeasurement

   - MeasurementSource enum (VISIT, SMS_FOLLOWUP, INTAKE, MANUAL)
8. **ADD** FollowUpRequest table (for SMS VAS tracking)
9. **ADD** default FeeScheduleItem seed data

   - Standard acupuncture CPT codes with suggested fees
10. **KEEP** cancellationReason (optional, useful)
11. **KEEP** practitionerNotes on Appointment (private per-visit notes)

---

## Questions for You

1. **Medications:** Keep as JSON with "current"/"significantPast" arrays? Or move to separate PatientMedication table? (Simpler vs more queryable)
2. **Recognition patterns:** For the unified text recognition (Subjective â†’ auto-link conditions, Plan â†’ auto-extract points), this is primarily UX/frontend logic. Schema is already set up to support it. Should I document the recognition patterns somewhere?
3. **Template content:** Keep simple string with | markers? Or add a templateFields Json for more structure later?
4. **Shall I proceed with schema changes now?**
