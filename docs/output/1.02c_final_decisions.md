# 1.02c Final Schema Decisions

**Date:** December 10, 2025
**Status:** Ready to implement schema changes

---

## Confirmed Decisions

### 1. PatientNote (CRM Notes)
- **Keep:** PatientNote table for CRM/rapport notes
- **Remove:** `practitionerNotes` from Appointment model
- **No categories:** Just `isPinned` and `isPrivate` fields
- **UX question pending:** How does entering notes integrate with intake flow?

### 2. Medical Profile History
- **Keep:** Hybrid approach (JSON current state + History table)
- **Flow confirmed:** Save updates both Patient.medicalProfile and creates MedicalProfileHistory record

### 3. PointSide Enum
- **Keep:** BILATERAL, LEFT, RIGHT, CENTER, CONTRALATERAL, IPSILATERAL
- **Remove:** Do not add GENDER_BASED (revisit later if needed)
- **Remove:** ProtocolSideType enum from PointProtocol

### 4. Treatment Side
- **No field on Visit:** Handle entirely in text entry within Plan section
- **Format:** "Bilateral treatment" at top, then points with exceptions noted

### 5. NeedlingTechnique
- **Keep:** TONIFYING, REDUCING, EVEN
- **Do NOT add NONE:** Use `null` as default (nullable field)
- **Text shorthand:** T (tonifying), R (reducing), E (even), nothing = null

### 6. Payment + Transactions
- **Confirmed:** Payment (like invoice) + PaymentTransaction (each payment event)
- **Payment.createdAt:** Visit/appointment day
- **Transaction.transactedAt:** When each payment occurred

### 7. VAS Score Display
- **MVP:** Simple line chart showing VAS over time
- **Visual:** Mark which days were appointment days (dots on timeline)
- **No distinction:** Between practitioner vs patient-entered for MVP

### 8. MeasurementSource Enum
- **Add now:** VISIT, PATIENT_INTAKE, SMS_FOLLOWUP, MANUAL
- **Defer:** FollowUpRequest table (premium feature later)

### 9. ProfileUpdateSource Enum
- **Add:** INITIAL_INTAKE, REEVALUATION_FORM, VISIT_UPDATE, PATIENT_PORTAL

### 10. Point Entry
- **Schema:** Already supports it (TreatmentPoint table)
- **UX:** Autocomplete dropdown when typing points (handled in frontend)
- **Document:** Recognition patterns in docs/specs/

### 11. TreatmentPackage
- **Add:** practitionerId (NULL = clinic-wide)
- **Add to PatientPackage:** restrictToPractitionerId

### 12. Other Confirmations
- **Keep:** cancellationReason on Appointment (optional)
- **Add:** MedicalProfileHistory table
- **Add:** PatientNote table (with isPinned, isPrivate)
- **Add:** PaymentMethod enum
- **Add:** PaymentStatus enum

---

## Outstanding Question

### PatientNote Entry UX

You asked: How do you enter patient notes in a way that doesn't feel like a completely separate UX from doing the intake?

**My suggestion:**

During intake/appointment flow, there's a small "Quick Note" area:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SUBJECTIVE                                                       â”‚
â”‚  [Main SOAP content here...]                                      â”‚
â”‚                                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  ğŸ’¬ Quick Note (optional)                    [Pin this note]      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Visiting daughter in Arizona next month                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  Recent notes: "Just got promoted" (Sep 20)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Small optional field at bottom of Subjective section
- Shows recent notes for context
- One tap to pin
- Feels integrated, not a separate screen
- Can also add from Patient Profile anytime

**Does this approach work for you?**

---

## Next Steps

### Immediate (Schema Changes)

1. **Update schema.prisma:**
   - Remove `practitionerNotes` from Appointment
   - Remove `ProtocolSideType` enum and `sideType` from PointProtocol
   - Make `technique` nullable on ProtocolPoint and TreatmentPoint (default null)
   - Add `practitionerId` to TreatmentPackage
   - Add `restrictToPractitionerId` to PatientPackage
   - Add PatientNote model (with isPinned, isPrivate)
   - Add MedicalProfileHistory model
   - Replace Payment model with Payment + PaymentTransaction
   - Add PaymentMethod enum
   - Add PaymentStatus enum
   - Add MeasurementSource enum to ConditionMeasurement
   - Add ProfileUpdateSource enum (for MedicalProfileHistory)
   - Add insurance fields to PaymentTransaction and Superbill

2. **Create docs/specs/recognition-patterns.md:**
   - Document Subjective text recognition (conditions, VAS scores)
   - Document Plan text recognition (points, protocols, techniques)
   - Document point entry shorthand format

3. **Create seed data:**
   - Default FeeScheduleItem records (CPT codes with suggested fees)

### After Schema
4. Update `.claude.md` with finalized architecture
5. Create handoff document `docs/handoffs/1.02_schema_refinement.md`

---

## Schema Changes Summary

```
REMOVE:
- Appointment.practitionerNotes
- ProtocolSideType enum
- PointProtocol.sideType

MODIFY:
- ProtocolPoint.technique â†’ nullable (no default)
- TreatmentPoint.technique â†’ nullable (no default)
- ConditionMeasurement â†’ add source field

ADD ENUMS:
- PaymentMethod (CARD, HSA, FSA, CASH, CHECK, INSURANCE_PAYOUT, PACKAGE_CREDIT, OTHER)
- PaymentStatus (PENDING, PARTIAL, PAID, REFUNDED, WRITTEN_OFF)
- MeasurementSource (VISIT, PATIENT_INTAKE, SMS_FOLLOWUP, MANUAL)
- ProfileUpdateSource (INITIAL_INTAKE, REEVALUATION_FORM, VISIT_UPDATE, PATIENT_PORTAL)
- NoteType removed (using isPinned/isPrivate instead)

ADD MODELS:
- PatientNote (id, patientId, visitId?, content, isPinned, isPrivate, createdAt, createdBy)
- MedicalProfileHistory (id, patientId, visitId?, section, changeType, changeDescription, previousValue, newValue, changedBy, changedAt, source)
- PaymentTransaction (id, paymentId, method, amount, stripePaymentIntentId?, cardLast4?, cardBrand?, patientPackageId?, creditsUsed?, checkNumber?, insuranceClaimId?, insuranceEraId?, isAutoPosted, notes?, transactedAt)

MODIFY MODELS:
- Payment â†’ add status field, remove paidWithCredits/paidWithCard, add transactions relation
- TreatmentPackage â†’ add practitionerId
- PatientPackage â†’ add restrictToPractitionerId
- Superbill â†’ add clearinghouseClaimId
```

---

Shall I proceed with the schema changes now?
