# Session 1.29: Layout Flash Fix, State Persistence, and UI Polish

## Context

Read these files first:
1. `.claude.md` - Project conventions
2. `docs/handoffs/1.28_scrolling_and_spacing_refinements.md` - Previous session changes
3. `prisma/schema.prisma` - Data model

## Issues to Fix

### 1. PatientCards Width Flash on Page Load (Today Screen)

**Problem:** On the Today screen (`/`), when the page loads or refreshes, the expanded PatientCards panel briefly shows at its minimum/collapsed width, then jumps to the correct expanded width. This causes a visual "flash" or layout shift.

**Where to look:**
- `src/components/custom/PatientCards.tsx` - The component
- `src/components/custom/TodayScreen.tsx` - Where PatientCards is used on Today
- Check how the width is being set/animated on initial render

**Goal:** The PatientCards should render at its correct width immediately on load without any width transition or flash.

**Hint:** This is likely related to:
- Initial state of `compact` prop
- CSS/Framer Motion animations running on mount
- The width might be transitioning from a default to the actual value

---

### 2. PatientCards Collapse State Persistence (Appointment Screen)

**Problem:** On the appointment detail screen (`/appointments/[id]`), there's a collapse/expand button for PatientCards. When expanded and the page is refreshed, it reverts to collapsed. The user wants this state to persist.

**Where to look:**
- `src/app/appointments/[id]/page.tsx` - Where PatientCards is used
- The `compact` state and `onToggleCompact` handler
- Similar persistence pattern exists for patient selection (see URL params usage)

**Goal:** Save the expanded/collapsed state so it persists across page refreshes.

**Options:**
1. **URL parameter** - Add `?cards=expanded` or similar (consistent with existing patterns)
2. **localStorage** - Store preference locally
3. **Cookie** - For SSR-compatible persistence

The project already uses URL params for patient selection persistence - check `1.26_patient_selection_persistence.md` handoff for the pattern.

---

### 3. Animation for Back Navigation (Appointment → Today)

**Problem:** When navigating back from `/appointments/[id]` to the Today screen, the user wants a smooth animation transition.

**Where to look:**
- `src/contexts/TransitionContext.tsx` - Handles page transition state
- `src/components/custom/Topbar.tsx` - Has the back button
- `src/components/custom/TodayScreen.tsx` - Destination of back navigation
- Check existing transition patterns in `1.13_navigation_animations.md` and `1.14_transition_refinements.md`

**Current behavior:** The app already has transitions for Today → Appointment (horizontal slide). The reverse might not be fully implemented.

**Goal:** Smooth animation when clicking "Back to Today" that feels like the reverse of the forward navigation.

---

### 4. Baseline Align "Today" and Date Text in Topbar

**Problem:** In the Topbar, the "Today" title and the date subtitle (e.g., "Sunday, December 15") are not baseline-aligned.

**Where to look:**
- `src/components/custom/Topbar.tsx` - Around lines 89-120 where the title/subtitle are rendered

**Current structure (likely):**
```tsx
<h1 className="text-xl font-semibold">Today</h1>
<span className="text-sm text-muted-foreground">Sunday, December 15</span>
```

**Goal:** Use `items-baseline` on the flex container so the text baselines align properly.

**Fix:** Change from `items-center` to `items-baseline` on the parent flex container.

---

## Priority Order

1. **Baseline align** - Quick CSS fix
2. **Width flash fix** - Important UX issue
3. **State persistence** - Feature enhancement
4. **Back animation** - Polish

## Key Files

| File | Relevance |
|------|-----------|
| `src/components/custom/Topbar.tsx` | Baseline alignment fix |
| `src/components/custom/PatientCards.tsx` | Width flash, collapse state |
| `src/components/custom/TodayScreen.tsx` | Width flash on Today |
| `src/app/appointments/[id]/page.tsx` | Collapse persistence, back animation |
| `src/contexts/TransitionContext.tsx` | Back animation |
| `src/lib/animations.ts` | Animation configs |

## Testing

- Refresh Today screen - no width flash on PatientCards
- Refresh `/appointments/[id]` with cards expanded - should stay expanded
- Click "Back to Today" - should animate smoothly
- Check Topbar text alignment on both screens
