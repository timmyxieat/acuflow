# Session 1.45: Patient Search Command Palette

## Context

Read these files first:
1. `.claude.md` - Project conventions
2. `docs/handoffs/1.44-adaptive-patient-context.md` - Previous session
3. `prisma/schema.prisma` - Data model

## Overview

Build a Spotlight-style command palette for searching patients. This should be a modal that opens globally via `⌘K` keyboard shortcut or by clicking the existing search button in the Topbar.

## Requirements

### Trigger Behavior

- **Keyboard shortcut:** `⌘K` (Mac) / `Ctrl+K` (Windows) should open the palette from any screen
- **Click trigger:** The existing "Search patients..." button in the Topbar should also open the palette
- **Dismiss:** Escape key, clicking outside, or selecting a result should close the palette

### Search Functionality

- Search by patient name (first, last, or preferred name)
- Search by phone number (should work with or without formatting)
- Search by condition name (e.g., typing "back pain" finds patients with that condition)
- Minimum 2 characters before showing results
- Fuzzy matching is acceptable

### Result Display

Each search result should show:
- Patient avatar (initials) and full name
- Demographics: sex and age (e.g., "F, 40y")
- Primary condition (if any)
- Appointment context - one of:
  - "Today at 10:30 AM" (highlighted) if they have an appointment today
  - "Next: Dec 20" if they have a future appointment
  - "Last seen Nov 15" if they only have past visits
- Visual indicator (dot) for patients with today appointments

**Density:** Match the PatientCards component density - same avatar size, similar typography scale.

### Selection Behavior

When a patient is selected:
- If they have an appointment today → navigate to `/appointments/{appointmentId}`
- If no appointment today → navigate to `/?patient={patientId}` (this highlights them in PatientCards if visible)

### Keyboard Navigation

- Arrow Up/Down: Navigate through results
- Enter: Select highlighted result
- Escape: Close palette

## Implementation Approach

### Use shadcn/ui Components

Install the `dialog` and `command` components from shadcn/ui:
```bash
npx shadcn@latest add dialog command
```

The Command component (built on cmdk library) provides accessible, keyboard-navigable search out of the box.

### Create a Search Context

Create a new context (`SearchContext`) to manage the open/close state globally. This allows any component to open the search palette.

**Where to look for context patterns:**
- `src/contexts/HeaderContext.tsx` - existing pattern for global state
- `src/contexts/TransitionContext.tsx` - another example

### Global Keyboard Handler

Add the `⌘K` listener at the app shell level so it works from any screen.

**Where to look:**
- `src/components/custom/AppShell.tsx` - wraps the entire app, good place for global handlers

### Simplify Topbar

The current Topbar has inline search state and a dropdown. Replace this with a simple button that opens the new command palette via the search context.

**Where to look:**
- `src/components/custom/Topbar.tsx` - has existing search button styling to preserve

### Existing Search Helper

A `searchPatients()` function already exists and handles name/phone/email matching. Enhance it to also match condition names.

**Where to look:**
- `src/data/mock/helpers.ts` - contains `searchPatients()` and related helpers
- `src/data/mock/patients.ts` - patient data structure
- `src/data/mock/conditions.ts` - condition data

### Appointment Context Helpers

These helpers already exist for getting appointment context:
- `getPatientTodayAppointmentId(patientId)` - returns today's appointment ID or null
- `getPatientVisitHistory(patientId)` - past completed visits
- `getPatientScheduledAppointments(patientId)` - future appointments
- `getPatientConditionsWithMeasurements(patientId)` - patient's conditions

## Key Files

| File | Purpose |
|------|---------|
| `src/components/custom/AppShell.tsx` | Add SearchProvider, global ⌘K handler |
| `src/components/custom/Topbar.tsx` | Simplify to use search context |
| `src/data/mock/helpers.ts` | Enhance searchPatients() |
| `src/contexts/HeaderContext.tsx` | Reference pattern for new context |
| `src/components/custom/PatientCards.tsx` | Reference for result item density |
| `src/lib/animations.ts` | Animation configs if needed |

## Files to Create

| File | Purpose |
|------|---------|
| `src/contexts/SearchContext.tsx` | Global open/close state |
| `src/components/custom/PatientSearchCommand.tsx` | The command palette component |
| `src/components/ui/dialog.tsx` | shadcn Dialog (via CLI) |
| `src/components/ui/command.tsx` | shadcn Command (via CLI) |

## Styling Guidelines

- Modal max-width: ~512px (centered)
- Results list max-height: ~320px (scrollable)
- Touch targets: minimum 44px height per result
- Use existing color tokens (`text-muted-foreground`, `bg-muted`, etc.)
- "Today" appointments should have blue highlighting to stand out
- Overlay backdrop: semi-transparent black

## Testing Checklist

- [ ] `⌘K` opens palette from Today screen
- [ ] `⌘K` opens palette from Appointment detail screen
- [ ] `⌘K` opens palette from Calendar screen
- [ ] Clicking Topbar search button opens palette
- [ ] Search by full name returns correct patients
- [ ] Search by partial name returns correct patients
- [ ] Search by phone number works
- [ ] Search by condition name works (e.g., "migraine")
- [ ] Results show correct appointment context
- [ ] Selecting patient with today appointment navigates to appointment
- [ ] Selecting patient without today appointment navigates to Today with param
- [ ] Arrow keys navigate results
- [ ] Enter selects highlighted result
- [ ] Escape closes palette
- [ ] Clicking outside closes palette
- [ ] No results state displays appropriately

## Success Criteria

The feature is complete when a practitioner can:
1. Press `⌘K` from anywhere in the app
2. Type a patient's name or condition
3. See relevant results with appointment context
4. Press Enter or click to navigate directly to that patient's appointment
