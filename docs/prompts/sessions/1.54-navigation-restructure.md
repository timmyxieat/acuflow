# 1.54 Navigation Restructure Implementation

## Assignment

Implement the navigation restructure designed in session 1.53. This is a significant layout change affecting both the Today screen and Appointment detail screen.

## Context

Read `docs/handoffs/1.53-navigation-redesign-spec.md` for the full design specification.

## Design Decisions (Confirmed)

1. **VisitContext grouping**: Avatar + Patient Name + Date/Time + Status = correct
2. **No Topbar on appointment pages**: VisitContext + TopTabBar together ARE the top bar
3. **PatientCards date header**: Just a label showing the date (not a dropdown picker)
4. **Search button**: Lives in the TopTabBar area (right side)

## Target Layouts

### Today Screen
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        â”‚                â”‚              Topbar                        â”‚
â”‚        â”‚  Date Label    â”‚     â—„â—„  â—„  Today  â–º  â–ºâ–º      [Search ğŸ”]  â”‚
â”‚Sidebar â”‚  "Dec 18"      â”‚     Thursday, December 18                  â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚        â”‚                â”‚                                            â”‚
â”‚        â”‚  PatientCards  â”‚              Timeline                      â”‚
â”‚        â”‚                â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Appointment Screen (NO separate Topbar)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        â”‚                â”‚  VisitContext        â”‚        TopTabBar             â”‚
â”‚        â”‚  Date Label    â”‚  â”Œâ”€â”€â”€â”€â”              â”‚                              â”‚
â”‚Sidebar â”‚  "Dec 18"      â”‚  â”‚ MT â”‚ â— Maria      â”‚  [Chart][Billing][Sched][ğŸ”] â”‚
â”‚        â”‚                â”‚  â””â”€â”€â”€â”€â”˜ Dec 18 10:00 â”‚                              â”‚
â”‚        â”‚                â”‚        â—€ In Prog â–¶   â”‚                              â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚        â”‚                â”‚  VisitTimeline â”‚      Appointment Content           â”‚
â”‚        â”‚  PatientCards  â”‚                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚        â”‚                â”‚  Dec 18 â—      â”‚  â”‚   MainContent   â”‚   Context   â”‚ â”‚
â”‚        â”‚                â”‚  Dec 10        â”‚  â”‚   (SOAP/Tabs)   â”‚             â”‚ â”‚
â”‚        â”‚                â”‚  Dec 3         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key insight**: On appointment pages, VisitContext + TopTabBar together form a single header row. There is no separate Topbar component rendered.

## Implementation Steps

### Phase 1: Create VisitContext Component

Create `src/app/appointments/[id]/components/VisitContext.tsx`:

```tsx
interface VisitContextProps {
  appointment: AppointmentWithRelations
  onStatusChange: (status: AppointmentStatus, isSigned: boolean) => void
}

// Layout:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  [Avatar]  â— Patient Name                            â”‚
// â”‚            Dec 18 Â· 10:00 AM - 11:00 AM              â”‚
// â”‚            â—€ In Progress â–¶                           â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

This component contains:
- Patient avatar (initials)
- Status dot (colored) + Patient name
- Appointment date and time range
- Status slider with prev/next arrows

Move the `StatusSlider` logic from current `TopTabBar.tsx` into this component.

**Width**: ~240-280px, fixed or min-width

### Phase 2: Refactor TopTabBar

Update `src/app/appointments/[id]/components/TopTabBar.tsx`:

**Remove:**
- Patient name display
- Status dot
- Status dropdown/slider (moved to VisitContext)

**Keep:**
- Tab buttons (Chart, Billing, Schedule, Comm)
- Tab preview badges (optional)

**Add:**
- Search button on the right side

```tsx
interface TopTabBarProps {
  activeTab: TabType
  onTabChange: (tab: TabType) => void
  billingData?: BillingData   // for badge
  scheduleData?: ScheduleData // for badge
  commsData?: CommsData       // for badge
}

// Layout:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  [Chart] [Billing] [Schedule] [Comm]        [ğŸ”]     â”‚
// â”‚   â•â•â•â•â•                                              â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Width**: flex-1 (fills remaining space)

### Phase 3: Update Appointment Page Layout

In `src/app/appointments/[id]/page.tsx`:

**Remove**: Any Topbar-related header setup for this page. The appointment page should NOT render the global Topbar.

**New structure** for the main content area (after PatientCards):

```tsx
{/* Main content area - NO Topbar here */}
<div className="flex flex-1 flex-col overflow-hidden">

  {/* Header row: VisitContext + TopTabBar */}
  <div className="flex h-14 border-b border-border flex-shrink-0">
    <VisitContext
      appointment={appointment}
      onStatusChange={handleStatusChange}
    />
    <TopTabBar
      activeTab={activeTab}
      onTabChange={handleTabChange}
      billingData={billingData}
      scheduleData={scheduleData}
      commsData={commsData}
    />
  </div>

  {/* Content area: VisitTimeline + AppointmentContent */}
  <div className="flex flex-1 overflow-hidden">
    {/* ... existing layout ... */}
  </div>
</div>
```

**Important**: Update `HeaderContext` usage. On appointment pages, we may need to:
- NOT call `setHeader({ showBackButton: true })`
- OR modify AppShell to conditionally hide Topbar

### Phase 4: Conditionally Hide Topbar

Update `src/components/custom/AppShell.tsx` or create a mechanism to hide Topbar on appointment pages.

**Option A**: Add a `hideTopbar` flag to HeaderContext
```tsx
// In HeaderContext
setHeader({ hideTopbar: true })

// In AppShell
{!header.hideTopbar && <Topbar />}
```

**Option B**: Check route in AppShell
```tsx
const pathname = usePathname()
const isAppointmentPage = pathname.startsWith('/appointments/')

{!isAppointmentPage && <Topbar />}
```

Recommend **Option A** for flexibility.

### Phase 5: Add Back Navigation

Since there's no Topbar on appointment pages, back navigation needs a home.

**Option**: Put back arrow in VisitContext (left side)

```tsx
// VisitContext layout with back arrow:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  â†  â”‚  [Avatar]  â— Patient Name                       â”‚
// â”‚     â”‚            Dec 18 Â· 10:00 AM                    â”‚
// â”‚     â”‚            â—€ In Progress â–¶                      â”‚
// â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Or make the avatar/area tappable to go back.

**Alternative**: Clicking the Sidebar logo "A" already navigates back to Today. This may be sufficient.

### Phase 6: Add Date Label to PatientCards

Update `src/components/custom/PatientCards.tsx`:

Add a simple date label header (NOT a dropdown):

```tsx
// At the top of PatientCards, before status groups:
<div className="px-3 py-2 border-b border-border">
  <span className="text-sm font-medium text-muted-foreground">
    {isToday(date) ? 'Today' : format(date, 'MMM d')}
  </span>
</div>
```

This just shows context - no interaction needed.

**When collapsed**: Hide the label or show abbreviated (e.g., just "18")

### Phase 7: Update TodayScreen

`src/components/custom/TodayScreen.tsx` should continue to work as-is. The Topbar still shows on Today screen with date navigation.

Verify:
- Topbar renders normally (date nav + search)
- PatientCards shows new date label
- Everything else unchanged

## Component Widths

| Component | Width |
|-----------|-------|
| Sidebar | 48px |
| PatientCards | clamp(180px, 20vw, 280px) |
| VisitContext | 240-280px (fixed or min-width) |
| TopTabBar | flex-1 |
| VisitTimeline | clamp(140px, 12vw, 180px) |
| Context panel | 280px |
| MainContent | flex-1 |

## Files to Modify

| File | Changes |
|------|---------|
| **NEW** `src/app/appointments/[id]/components/VisitContext.tsx` | Create component |
| `src/app/appointments/[id]/components/TopTabBar.tsx` | Remove patient/status, add search |
| `src/app/appointments/[id]/components/index.ts` | Export VisitContext |
| `src/app/appointments/[id]/page.tsx` | New layout, hide topbar |
| `src/components/custom/PatientCards.tsx` | Add date label header |
| `src/components/custom/AppShell.tsx` | Conditional Topbar rendering |
| `src/contexts/HeaderContext.tsx` | Add hideTopbar flag (if using Option A) |

## Testing Checklist

- [ ] Today screen: Topbar shows with date navigation
- [ ] Today screen: PatientCards shows date label
- [ ] Appointment screen: NO Topbar rendered
- [ ] Appointment screen: VisitContext shows patient + date + status
- [ ] Appointment screen: TopTabBar shows tabs + search
- [ ] Status slider works (prev/next arrows)
- [ ] Tabs switch content correctly
- [ ] Back navigation works (via Sidebar logo or dedicated button)
- [ ] Keyboard shortcuts still work
- [ ] Animations between screens still work

## Summary

The key change is: **on appointment pages, VisitContext + TopTabBar replace the Topbar entirely**. They form a unified header row that contains all the appointment-specific info (patient, date, status, tabs, search).

The global Topbar only renders on non-appointment pages (Today, Calendar, Settings).
