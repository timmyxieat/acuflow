# 1.54 Navigation Restructure Implementation

## Assignment

Implement the navigation restructure designed in session 1.53. This is a significant layout change affecting both the Today screen and Appointment detail screen.

## Context

Read `docs/handoffs/1.53-navigation-redesign-spec.md` for the full design specification.

## Goals

1. Create the new `VisitContext` component
2. Refactor `TopTabBar` to work alongside `VisitContext`
3. Add date header to `PatientCards`
4. Simplify `Topbar` for appointment pages
5. Update layouts for both screens

## Implementation Steps

### Phase 1: Create VisitContext Component

Create `src/app/appointments/[id]/components/VisitContext.tsx`:

```tsx
// VisitContext: Patient name + appointment date/time + status slider
//
// Props:
//   - appointment: AppointmentWithRelations
//   - onStatusChange: (status, isSigned) => void
//
// Layout:
//   ┌─────────────────────────────────────────┐
//   │  [Avatar]  ● Patient Name               │
//   │            Dec 18 · 10:00 AM            │
//   │            ◀ In Progress ▶              │
//   └─────────────────────────────────────────┘
```

Move status slider logic from `TopTabBar.tsx` into this component.

### Phase 2: Refactor TopTabBar

Update `src/app/appointments/[id]/components/TopTabBar.tsx`:

- Remove patient name (now in VisitContext)
- Remove status slider (now in VisitContext)
- Keep only: Tab buttons (Chart, Billing, Schedule, Comm)
- Optionally add search button on right

The component should be simpler:
```tsx
// TopTabBar: Just the tabs
// Props:
//   - activeTab: TabType
//   - onTabChange: (tab) => void
//   - billingData, scheduleData, commsData (for badge counts)
```

### Phase 3: Update Appointment Page Layout

In `src/app/appointments/[id]/page.tsx`:

Current TopBar area structure:
```tsx
<TopTabBar ... />
```

New TopBar area structure:
```tsx
<div className="flex h-14 border-b border-border">
  <VisitContext
    appointment={appointment}
    onStatusChange={handleStatusChange}
  />
  <TopTabBar
    activeTab={activeTab}
    onTabChange={handleTabChange}
    ...
  />
</div>
```

### Phase 4: Add Date Header to PatientCards

Update `src/components/custom/PatientCards.tsx`:

Add a header section showing the current date:
```tsx
// Before the status groups, add:
<div className="px-3 py-2 border-b border-border">
  <button className="flex items-center gap-1 text-sm font-medium">
    {isToday(date) ? 'Today' : formatDate(date)}
    <ChevronDown className="h-4 w-4" />
  </button>
</div>
```

For now, the dropdown can be a placeholder (future: date picker popover).

### Phase 5: Simplify Topbar for Appointment Pages

Update `src/components/custom/Topbar.tsx`:

When `header.showBackButton` is true (appointment page):
- Show minimal topbar OR
- Hide topbar entirely and let VisitContext + TopTabBar be the "header"

Option A - Minimal topbar:
```tsx
{header.showBackButton && (
  <header className="flex h-14 items-center px-3 border-b border-border">
    <button onClick={handleBack}>
      <ArrowLeft /> Back to Today
    </button>
    <div className="ml-auto">
      <SearchButton />
    </div>
  </header>
)}
```

Option B - No topbar on appointment pages (VisitContext is the header):
- Move back button into VisitContext or sidebar
- Search moves to TopTabBar

Recommend starting with Option A for simplicity.

### Phase 6: Update TodayScreen

Ensure `src/components/custom/TodayScreen.tsx` works with the new PatientCards header.

The Topbar on Today screen should continue to show:
- Date navigation (‹‹ ‹ Today › ››)
- Week selector
- Search button

## Component Widths

| Component | Width |
|-----------|-------|
| Sidebar | 48px |
| PatientCards | clamp(180px, 20vw, 280px) |
| VisitContext | ~240px (or flex with min-width) |
| TopTabBar | flex-1 |
| VisitTimeline | clamp(140px, 12vw, 180px) |
| Context panel | 280px |
| MainContent | flex-1 |

## Files to Modify

1. **NEW** `src/app/appointments/[id]/components/VisitContext.tsx`
2. `src/app/appointments/[id]/components/TopTabBar.tsx`
3. `src/app/appointments/[id]/components/index.ts` (export VisitContext)
4. `src/app/appointments/[id]/page.tsx`
5. `src/components/custom/PatientCards.tsx`
6. `src/components/custom/Topbar.tsx`

## Testing Checklist

- [ ] Today screen shows date navigation in Topbar
- [ ] PatientCards shows date header on both screens
- [ ] Appointment screen shows VisitContext with patient name + date + status
- [ ] Status slider works in VisitContext
- [ ] Tabs work in TopTabBar
- [ ] Back navigation works
- [ ] Keyboard shortcuts still work
- [ ] Animations between screens still work
- [ ] Responsive behavior at different iPad sizes

## Notes

- Preserve existing animation logic (usePageAnimations hook)
- Keep the same data flow (appointment, timer, SOAP, etc.)
- This is a layout restructure, not a data model change
- Build passes before and after each phase

## Reference

Current component locations:
- `src/components/custom/Topbar.tsx` - Global topbar
- `src/components/custom/PatientCards.tsx` - Patient queue
- `src/app/appointments/[id]/page.tsx` - Appointment page
- `src/app/appointments/[id]/components/TopTabBar.tsx` - Current tab bar with patient name + status
