# 1.09: Build Appointment Detail Screen

## Context

We have a working Today screen with a split layout (Timeline + PatientCards + AppointmentPreview). When clicking "Open Full Record" on the AppointmentPreview, it should navigate to a new **Appointment Detail Screen** where practitioners document the visit.

If you haven't already, read `docs/handoffs/1.08_scrollable_area_refactor.md` for ScrollableArea patterns and `.claude.md` for project conventions.

---

## Screen Layout: Two-Column Split

### Left Panel (~300px, scrollable)

- **Back navigation** — uses browser history (`router.back()`) to return wherever they came from
- **Patient header:** avatar, name, sex, age
- **Visit timeline:** vertical list of past visits for this patient
  - Each card shows: date, chief complaint (truncated), appointment type icon
  - **"Currently viewing"** card highlighted with darker background
  - Cards are clickable — clicking changes which visit's preview appears below SOAP sections
  - Show signed status: small checkmark icon on signed visits, no icon on unsigned
  - Use `ScrollableArea`
  - **Empty state:** First visit for patient — show friendly message (agent discretion on copy)

### Right Panel (flex-1, scrollable)

#### Header Row
- "Appointment today" with time and contextual countdown
  - Before start: "10:00 AM · in 5 minutes"
  - During: "10:00 AM · 15 min remaining" (time until scheduled end)
  - After: "10:00 AM · ended 10 min ago"
- Status badge (Scheduled / In Progress / Completed)
- Action button (changes based on status):
  - Scheduled → "Start Appointment"
  - In Progress → "End Appointment"
  - Completed + unsigned → "Sign Note"
  - Completed + signed → (no action button, or "View Summary")

#### Patient Intake Section (collapsible)
- Placeholder for now (patient intake form system is future feature)
- Collapsible section with "Expand" toggle
- Stub with placeholder content

#### SOAP Sections (Subjective, Objective, Assessment, Plan)

Each section has:
- **Section header** (bold label)
- **Editable textarea** (white background, border) — auto-saves on change
- **Preview line below:** shows content from the visit selected in left timeline
  - Muted text, left border accent, light gray background
  - Format: `CC: Headache | HPI: Stabbing pain | ...`
  - No date label needed — the timeline highlight indicates which visit is previewed
  - Clicking "Currently viewing" card in timeline resets to previous visit's preview

> **Plan section:** Has "Use past treatment" button in header to copy treatment protocol

---

## Key UX Decisions

1. **Preview lines are read-only reference** — visually distinct from editable areas (muted, smaller, left border)
2. **Timeline selection controls preview** — clicking a past visit card changes all preview lines to that visit's content
3. **Status transitions:** Scheduled → In Progress → Completed (then signing is separate action)
4. **Auto-save always** — show subtle "Saved" indicator after save completes
5. **Use existing mock data** — extend if needed for visit history
6. **Signing workflow:** After "End Appointment", status becomes COMPLETED but unsigned. Action button becomes "Sign Note".

---

## Technical Patterns

### Auto-Save Architecture

Create an abstraction layer so mock implementation swaps cleanly for real DB later:

```
Component → lib/api/visits.ts → Mock (localStorage + delay) → Later: Prisma
```

**Create:**
- `lib/api/visits.ts` — async functions: `saveVisitSOAP()`, `getVisit()`, etc.
- `hooks/useAutoSave.ts` — debounced save (1s delay) with status: `idle | saving | saved`

**Mock implementation:**
- Store in localStorage keyed by `visit_${id}_${section}`
- Add 300ms artificial delay to simulate network
- Return `{ success: true }`

**UI shows:** "Saving..." → "Saved ✓" (fades after 2s)

---

## Implementation Approach

1. Create route: `/appointments/[id]/page.tsx`
2. Build the two-column layout shell first
3. Add patient header and visit timeline (left)
4. Add appointment header with status/actions (right)
5. Add SOAP sections with preview pattern (right)
6. Wire up "Open Full Record" button from AppointmentPreview
7. Add mock visit history data for the patient

---

## Start With

Build the layout shell and navigation first. Get the two-column structure working with placeholder content, then fill in each section. Use existing components (`ScrollableArea`, status colors from `constants.ts`) where applicable.

---

## Out of Scope (Future)

- Patient intake form system (stub the section for now)
- Treatment timer display (separate from appointment timing)
- Tongue photo uploads
