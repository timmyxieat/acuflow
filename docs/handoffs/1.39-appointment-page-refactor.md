# 1.39 Appointment Page Refactor

**Date:** December 16, 2024
**Status:** Complete

## Summary

Refactored the massive appointment detail page (2,263 lines, ~26,299 tokens) into modular co-located files to fix Claude Code's "exceeds maximum tokens" error and improve maintainability.

## What Changed

### Problem
`src/app/appointments/[id]/page.tsx` was 2,263 lines (~26,299 tokens), exceeding Claude's 25,000 token file read limit. This caused errors during agentic coding sessions.

### Solution
Split the file into co-located modules following a new file organization pattern:

```
src/app/appointments/[id]/
├── page.tsx                    # 770 lines (down from 2,263)
├── components/
│   ├── index.ts               # Barrel exports
│   ├── VisitTimeline.tsx      # 557 lines - timeline panel
│   ├── FABPanel.tsx           # 292 lines - floating action button + timer
│   ├── SOAPSections.tsx       # 179 lines - SOAP note editor
│   ├── TabBar.tsx             # 132 lines - bottom tab navigation
│   └── AppointmentHeader.tsx  # 91 lines - header bar
├── hooks/
│   └── useTimer.ts            # 93 lines - timer state logic
└── lib/
    └── helpers.ts             # 172 lines - constants & date utilities
```

### Files Modified/Created

**New files:**
- `src/app/appointments/[id]/components/*.tsx` - 5 component files + index.ts
- `src/app/appointments/[id]/hooks/useTimer.ts`
- `src/app/appointments/[id]/lib/helpers.ts`
- `.claude/rules/file-organization.md` - New guidelines document

**Modified files:**
- `src/app/appointments/[id]/page.tsx` - Refactored to import from modules
- `.claude.md` - Added "File Size Limits" section

## New Patterns Documented

### File Organization Rule
- Keep files under ~700 lines / ~25,000 tokens
- For complex pages, use co-located modules: `components/`, `hooks/`, `lib/`
- Use barrel exports (`index.ts`) for clean imports

See `.claude/rules/file-organization.md` for full guidelines.

## Current State

- Build passes ✅
- All functionality preserved
- TabBar was modified by linter to simplify (h-11 height, single row with icon + status text)

## Known Issues

None. The refactor is complete and functional.

## Pending: Animation Logic Refactor

**Wait for the current animation coder to finish their work first**, then refactor the animation logic throughout the appointment detail page.

### Current Problem
Animation logic is scattered and hard to reason about:
- `page.tsx` calculates `shouldAnimateMiddlePanel`, `isSamePatientNavigation`, keys
- `AppointmentHeader.tsx` duplicates the same logic, handles its own animations
- Each section has its own AnimatePresence with similar but slightly different conditions

### Proposed Approach
1. Document animation rules in a clear spec table:

| Scenario | Trigger | Left Section | Center/Right | Visit History | SOAP/Context |
|----------|---------|--------------|--------------|---------------|--------------|
| **From Today** | Click patient card on Today screen | Slide right→ | Slide right→ | Slide right→ | Slide right→ |
| **Same Patient** | Click in Visit History (same patient) | **Static** | Slide ↑↓ | **Static** | Slide ↑↓ |
| **Different Patient** | Click different patient in PatientCards | Slide ↑↓ | Slide ↑↓ | Slide ↑↓ | Slide ↑↓ |
| **Back to Today** | Back button / ESC | Slide ←left | Slide ←left | Slide ←left | Slide ←left |

2. Create `lib/animation-config.ts` - Single source of truth for animation rules
3. Create `usePageAnimations` hook - Returns animation props for each section
4. Simplify components - They receive animation props, don't calculate them

### Key Insight
- **Static sections** get a stable key (e.g., `patient-${patientId}`)
- **Animating sections** get a changing key (e.g., `appointment-${appointmentId}`)
- Animation direction determined once, passed down consistently

## Testing Done

- `npm run build` - passes
- All files are now under 700 lines and within token limits

## Next Steps

No immediate follow-up needed. The pattern is documented for future use.
