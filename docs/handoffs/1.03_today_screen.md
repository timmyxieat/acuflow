# 1.03 Today Screen Implementation

**Date:** December 10, 2024
**Phase:** 1 - Foundation
**Focus:** Building the main dashboard (Today screen) at route `/`

---

## What Was Built

### Today Screen Layout (`/` route)

A split-view dashboard for managing the day's appointments:

```
┌─────────────────────────────────────────────────────────────────┐
│  Topbar                                                          │
├──────────┬──────────────────────────────────────────────────────┤
│          │                                                       │
│          │  ┌─────────────────────────┐  ┌──────────────────┐   │
│  Sidebar │  │      Timeline           │  │  Patient Cards   │   │
│          │  │      (2/3 width)        │  │  (1/3 width)     │   │
│          │  │                         │  │                  │   │
│          │  │  8 AM - 6 PM schedule   │  │  Grouped by      │   │
│          │  │  with appointment       │  │  status          │   │
│          │  │  blocks                 │  │                  │   │
│          │  └─────────────────────────┘  └──────────────────┘   │
└──────────┴──────────────────────────────────────────────────────┘
```

### Components Created

#### `TodayScreen.tsx`
- Main container with flex layout (2/3 + 1/3 split)
- Manages selected appointment state
- Coordinates click handlers between Timeline and PatientCards

#### `Timeline.tsx`
- Visual day schedule from 8 AM to 6 PM
- Hour grid with labels on left side
- Appointment blocks positioned by time
- Handles overlapping appointments with smart column assignment
- Current time indicator (red line with dot and time label)
- Status badges on appointment blocks
- Shows: time range, patient name, appointment type, conditions

#### `PatientCards.tsx`
- Patients grouped by status (priority order):
  1. **In Progress** (blue) - Active treatments
  2. **Checked In** (green) - Waiting patients
  3. **Scheduled** (gray) - Upcoming
  4. **Unsigned** (amber) - Completed but needs signature
  5. **Completed** (slate) - Done and signed
- Each card shows: name, age, sex icon, primary condition, time
- Treatment state indicators for in-progress patients:
  - MessageCircleMore icon: Consultation phase (no needles)
  - Syringe icon: Needles in, patient resting
  - AlarmClockCheck icon: Needles out, wrapping up
- Wait time display for checked-in patients
- End time shown for in-progress (vs start time for others)

#### `dev-time.ts`
- Development utility that shifts current time to 11 AM
- Allows testing in-progress appointment states regardless of actual time
- Only active in development mode
- Used by Timeline (current time indicator) and PatientCards (wait/treatment time calculations)

### Mock Data (`mock-data.ts`)

Comprehensive test data including:

**Clinic & Practitioners:**
- Harmony Acupuncture & Wellness clinic
- Dr. Sarah Chen (Owner, L.Ac., DAOM)
- Michael Wong (Practitioner, L.Ac.)

**Appointment Types:**
- Initial Consultation (90 min, indigo)
- Follow-up Treatment (60 min, emerald)
- Brief Follow-up (30 min, amber)

**Patients (8 total):**
- Emily Johnson, Robert Martinez, Jennifer Lee, David Kim
- Maria Garcia, James Thompson, Susan Brown, William Davis

**Conditions (13 total):**
- Low back pain, stress/anxiety, knee pain, hypertension
- Migraines, neck tension, insomnia, tinnitus
- Dysmenorrhea, shoulder pain, digestive issues, fatigue, sciatica

**Today's Appointments:**
- 2 completed (1 signed, 1 unsigned)
- 3 in-progress (different treatment states)
- 1 checked-in
- 2 scheduled
- 1 cancelled

**Helper Functions:**
- `getEnrichedAppointments()` - Joins appointments with patient/practitioner/type/conditions
- `getAppointmentsByStatus()` - Groups for PatientCards
- `calculateAge()`, `getPatientDisplayName()`, `getStatusDisplay()`
- `searchPatients()`, `getAppointmentsForDate()`

### Visual Design Decisions

- Clean card-based UI with subtle borders and shadows
- Color-coded status indicators matching the design system
- Lucide icons for sex (Mars/Venus) and treatment states
- Compact patient cards with essential info only
- Timeline blocks show more detail (time range, conditions)
- Current time clearly visible with red indicator

---

## Technical Notes

### Overlapping Appointments
The Timeline handles overlapping appointments by:
1. Detecting overlap between appointment time ranges
2. Grouping overlapping appointments together
3. Assigning columns within each group
4. Calculating width/left position based on column count

### Treatment State Tracking
In-progress appointments track three states via timestamps:
1. `startedAt` - Treatment began (consultation)
2. `needleInsertionAt` - Needles inserted (patient resting)
3. `needleRemovalAt` - Needles removed (wrapping up)

PatientCards shows different icons and time displays for each state.

### Type Safety
All types derived from Prisma schema via `@/generated/prisma/browser`:
- Uses Prisma-generated types (`Patient`, `Appointment`, etc.)
- Uses Prisma enums (`AppointmentStatus`, `BiologicalSex`, etc.)
- Extended types for UI (`AppointmentWithRelations`)

---

## Files Changed/Created

```
src/
├── app/
│   └── page.tsx                    # Renders TodayScreen
├── components/custom/
│   ├── TodayScreen.tsx             # Main dashboard container
│   ├── Timeline.tsx                # Day schedule view
│   ├── PatientCards.tsx            # Status-grouped patient list
│   └── index.ts                    # Exports
├── data/
│   └── mock-data.ts                # Comprehensive mock data
└── lib/
    └── dev-time.ts                 # Dev time shifting utility
```

---

## Pending Work

1. **Navigation:** `handleAppointmentClick` logs but doesn't navigate to patient/visit view
2. **Patient View:** No patient detail screen exists yet
3. **Visit/SOAP View:** No clinical documentation screen yet
4. **Real-time Updates:** Timers don't auto-update (would need interval or animation frame)
5. **Cancelled/No-Show Section:** Listed in status grouping but not rendered in UI

---

## Next Steps

Likely next focus areas:
- Patient detail view (profile, conditions, visit history)
- Appointment/Visit view for documentation
- SOAP note interface
- Click-through navigation from Today screen
