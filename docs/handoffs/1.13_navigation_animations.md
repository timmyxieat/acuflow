# 1.13 Navigation Animations & PatientCards Collapse

## Session Summary

Implemented smooth page transitions between Today screen and Appointment detail, plus granular collapse/expand animations for PatientCards sidebar. Created a TransitionContext to coordinate animations across route changes.

## What Was Built/Changed

### 1. Page Transition System
- Created `TransitionContext` to track transition state across route changes
- Tracks `transitionSource` ('today' | 'appointment') to determine animation type
- Tracks `slideDirection` ('up' | 'down') for appointment-to-appointment navigation
- Stores origin rect for potential expand-from-origin animations

### 2. Today → Appointment Transition (Option 1: Coordinated Width + Slide)
- PatientCards sidebar animates width from 200px → auto (collapses)
- Appointment detail content slides in from the right
- Timeline slides out, detail slides in with 50ms stagger

### 3. Appointment → Today Transition (Reverse)
- PatientCards sidebar expands from 64px → 200px
- Timeline slides in from the left
- Mirrored timing from forward transition

### 4. Appointment ↔ Appointment Transition
- Sidebar stays collapsed (no width animation)
- Content slides vertically based on position:
  - Click patient below → content slides down (enters from top)
  - Click patient above → content slides up (enters from bottom)
- Selection indicator slides between patient cards (S2 animation)

### 5. PatientCards Collapse Animation (Granular)
- **Status Header**: Dot and count have `layoutId` for position morphing, title fades out with width collapse
- **Patient Card**: Avatar has `layoutId` for position animation, name container fades out, compact time fades in
- **Selection Indicator**: Unique `layoutId` per card for sliding between selections
- Uses `LayoutGroup` to coordinate all layout animations

### 6. PatientCards Styling Updates
- Removed borderRadius from collapsed selection indicator
- Container hugs children width (no fixed 64px)
- Compact card: 8px top padding, matching heights (62px)
- Status count in collapsed mode uses muted text
- Time width 32px in collapsed mode, "Done" text when timer up

## Key Files Modified

| File | Changes |
|------|---------|
| `src/contexts/TransitionContext.tsx` | **NEW** - Manages transition state across routes |
| `src/components/custom/AppShell.tsx` | Added TransitionProvider wrapper |
| `src/components/custom/PatientCards.tsx` | Major refactor for layout animations, unified card component |
| `src/components/custom/TodayScreen.tsx` | Added Framer Motion, reverse animations |
| `src/components/custom/Timeline.tsx` | Updated click handler to pass DOMRect |
| `src/app/appointments/[id]/page.tsx` | Page transition animations, direction tracking |

## Current State

**Working:**
- Page transitions between Today and Appointment detail
- Reverse animations when going back to Today
- Vertical slide between appointments (contextual direction)
- Selection indicator slides between patient cards
- Status header collapses with morphing dot/count
- PatientCard layout animations (avatar position, name fade)

**Animation Timing:**
- Page transitions: 300ms, ease-out curve `[0.4, 0, 0.2, 1]`
- Layout animations: Spring (stiffness: 500, damping: 35)
- Fade transitions: 150-200ms

## Pending Work / Known Issues

1. **Time element transition**: Currently name+time fade out together and compact time fades in separately. Could be improved to morph the time element position directly.

2. **Layout animation performance**: Many `layoutId` elements may cause performance issues on slower devices. Consider reducing or optimizing.

3. **AnimatePresence mode**: Using `mode="popLayout"` which may cause layout shifts. Test thoroughly.

4. **First load animation**: When first loading appointment page directly (not from Today), the sidebar animates from 200px which may look odd.

## Technical Notes

### TransitionContext API
```typescript
interface TransitionContextType {
  origin: TransitionOrigin | null  // Click origin rect
  isTransitioning: boolean
  transitionSource: 'today' | 'appointment'
  slideDirection: 'up' | 'down' | null
  startTransition: (rect: DOMRect, source: TransitionSource) => void
  setSlideDirection: (direction: SlideDirection) => void
  completeTransition: () => void
}
```

### Layout Animation Pattern
```typescript
// Use layoutId for elements that morph position
<motion.div layoutId={`avatar-${id}`} transition={springTransition}>

// Use AnimatePresence for elements that appear/disappear
<AnimatePresence mode="popLayout">
  {!compact && <motion.div initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}>}
</AnimatePresence>

// Wrap with LayoutGroup for coordinated animations
<LayoutGroup>
  {/* All cards with layoutIds */}
</LayoutGroup>
```

### Spring Transition Config
```typescript
const springTransition = {
  type: "spring" as const,
  stiffness: 500,
  damping: 35
}
```

## Files Created This Session

- `src/contexts/TransitionContext.tsx`
- `docs/handoffs/1.13_navigation_animations.md` (this file)
