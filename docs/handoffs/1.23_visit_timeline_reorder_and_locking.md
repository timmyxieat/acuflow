# Session 1.23: Visit Timeline Reorder and Future Appointment Locking

## Summary

This session restructured the Visit Timeline to follow appointment lifecycle order and added logic to restrict editing future appointments until earlier ones are completed.

## What Was Built

### 1. Reordered Visit Timeline Sections by Status Lifecycle

**Old order:** Today → Upcoming → Unsigned → History

**New order:**
1. Scheduled - Future appointments not yet started
2. Checked In - Patient has arrived, waiting
3. In Progress - Currently being treated
4. Unsigned - Completed but needs signature
5. Completed - Signed and done

This mirrors the PatientCards order and follows the natural appointment workflow.

### 2. Restrict Editing to Next Available Appointment

**Rule:** Users can only edit the ONE upcoming appointment closest to today. Further future appointments are locked.

**Logic:**
- If today has any active appointment (Scheduled, Checked In, In Progress), ALL future appointments are locked
- Only when today is clear can the next future appointment be edited
- Locked appointments show muted styling + lock icon with tooltip

### 3. Collapsed Section Shows Unlocked Only

When the Scheduled section is collapsed:
- Shows only unlocked appointments (today's + next available future if any)
- Locked appointments are hidden
- "Show all" button reveals locked appointments

### 4. Default Select Most Recent Visit for Preview

- On page load, auto-selects the most recent completed visit
- Preview content appears immediately without requiring a click

### 5. Preview Animation with Vertical Slide

- Switching visits slides preview content vertically based on direction
- Uses `mode="popLayout"` for crossfade (no height collapse)
- Click below → content slides down, click above → content slides up

## Key Files Modified

| File | Changes |
|------|---------|
| `src/app/appointments/[id]/page.tsx` | All changes - timeline reorder, locking logic, preview animation |

## Technical Details

### Timeline Colors Updated
```typescript
const TIMELINE_COLORS = {
  scheduled: '#94a3b8',  // Slate
  checkedIn: '#22c55e',  // Green
  inProgress: '#3b82f6', // Blue
  unsigned: '#f59e0b',   // Amber
  completed: '#94a3b8',  // Slate
  editing: '#3b82f6',    // Blue
}
```

### Future Appointment Locking Logic
```typescript
// Check if today has active appointments
const hasActiveTodayAppointment = todayAppointments.some(a =>
  a.status === 'SCHEDULED' ||
  a.status === 'CHECKED_IN' ||
  a.status === 'IN_PROGRESS'
)

// If today has active, all future locked
const nextAvailableFutureId = hasActiveTodayAppointment
  ? null
  : (futureScheduledAppts[0]?.id ?? null)

// Lock check
const isAppointmentLocked = (appointment) => {
  if (!appointment.isFuture) return false
  if (appointment.id === currentAppointmentId) return false
  return appointment.id !== nextAvailableFutureId
}
```

### Preview Animation
```typescript
<AnimatePresence mode="popLayout">
  <motion.div
    initial={{ y: direction === 'up' ? -20 : 20, opacity: 0 }}
    animate={{ y: 0, opacity: 1 }}
    exit={{ y: direction === 'up' ? 20 : -20, opacity: 0 }}
  >
    {previewContent}
  </motion.div>
</AnimatePresence>
```

## UI Changes

- Middle panel width: 300px → 200px (matches PatientCards expanded width)
- Section gap: gap-4 → gap-3 (matches PatientCards)
- Removed "+X more" indicator (redundant with header count)
- Locked cards: muted text, lock icon, tooltip, cursor-not-allowed

## Current State

Feature is complete and functional:
- Sections display in lifecycle order
- Future appointments lock correctly based on today's status
- Preview auto-selects and animates smoothly
- All styling matches PatientCards

## No Known Issues

All acceptance criteria met.
