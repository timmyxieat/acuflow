# Session 1.18: Scheduled Visits Timeline & SOAP Persistence

## Summary

This session expanded the visit timeline to show scheduled future appointments and added localStorage persistence for SOAP notes, ensuring work isn't lost between sessions.

## What Was Built/Changed

### 1. Scheduled Visits in Timeline

The visit timeline now shows three sections:

| Section | Description |
|---------|-------------|
| **Current Appointment** | Today's appointment being viewed (highlighted) |
| **Past Visits** | Completed visits with SOAP history (existing) |
| **Scheduled** | Future appointments for this patient (new) |

**ScheduledVisitCard component:**
- Shows date (Today, Tomorrow, or "Dec 21")
- Shows appointment type with icon
- Click to navigate to that appointment
- Current appointment shown with permanent selection state

**Navigation between scheduled visits:**
- Clicking a scheduled appointment navigates with vertical slide animation
- Uses new `'scheduled'` transition source
- Patient panel stays static (only SOAP panel animates)

### 2. SOAP Persistence to localStorage

**`src/lib/api/visits.ts` changes:**
- `loadVisitSOAP(appointmentId)` - loads from localStorage
- `saveVisitSOAP()` - now saves to localStorage (reduced delay to 300ms)
- Storage key format: `acuflow_soap_{appointmentId}`

**On appointment load:**
1. Check localStorage for saved SOAP data
2. If found, load into state and mark as "already saved"
3. If not found, initialize empty and mark as saved (prevents spurious initial save)

### 3. Auto-Save Hook Improvements

**`src/hooks/useAutoSave.ts` fixes:**

| Issue | Fix |
|-------|-----|
| Debounce timer reset on every render | Use refs for `onSave` and `data` callbacks |
| Loaded data triggers immediate save | Added `markAsSaved(dataOverride?)` function |
| Unnecessary recreations | Save callback no longer depends on data/onSave |

**New API:**
```typescript
const { status, markAsSaved } = useAutoSave({...})

// Mark loaded data as already saved
markAsSaved(loadedData)
```

### 4. Mock Data for Future Appointments

**`src/data/mock-data.ts` additions:**
- `mockFutureAppointments[]` - 4 future appointments (3 for Emily, 1 for Jennifer)
- `getAppointmentById(id)` - searches today + future appointments
- `getPatientScheduledAppointments(patientId, currentAppointmentId)` - returns all scheduled visits
- `ScheduledAppointmentWithType` interface

### 5. Animation Changes

**TransitionContext:**
- Added `'scheduled'` as new transition source type

**Appointment detail page animations:**
- `transitionSource === 'scheduled'` keeps patient panel static
- Only right panel (SOAP content) animates vertically
- Smoother UX when switching between scheduled visits for same patient

## Key Files Modified

| File | Changes |
|------|---------|
| `src/app/appointments/[id]/page.tsx` | ScheduledVisitCard, navigation, SOAP load/save integration |
| `src/contexts/TransitionContext.tsx` | Added 'scheduled' transition source |
| `src/data/mock-data.ts` | Future appointments data and helper functions |
| `src/hooks/useAutoSave.ts` | Ref-based callbacks, markAsSaved function |
| `src/lib/api/visits.ts` | localStorage load/save functions |

## Current State

**Working:**
- ✅ Visit timeline shows past visits + scheduled appointments
- ✅ Click scheduled appointment navigates with proper animation
- ✅ SOAP notes persist to localStorage
- ✅ Auto-save works without spurious saves on load
- ✅ Patient panel stays static when switching scheduled visits
- ✅ Current appointment highlighted in timeline

**Not yet implemented:**
- Keyboard navigation for scheduled visits section
- Visual distinction between today's other appointments vs future dates
- Edit/cancel scheduled appointments from timeline

## Testing Checklist

- [x] Visit timeline shows "Scheduled" section with future appointments
- [x] Clicking scheduled appointment navigates to it
- [x] Patient panel doesn't animate when switching scheduled visits
- [x] SOAP content typed → refresh page → content restored
- [x] Switching appointments loads correct SOAP data
- [x] No "Saving..." flash on initial load

## Technical Notes

### localStorage Structure
```
acuflow_soap_appt_001 = {"subjective":"...","objective":"...","assessment":"...","plan":"..."}
acuflow_soap_appt_002 = {...}
```

### Ref Pattern for Stable Callbacks
```typescript
const onSaveRef = useRef(onSave)
onSaveRef.current = onSave

const save = useCallback(async () => {
  await onSaveRef.current(dataRef.current)
}, []) // No dependencies - never recreated
```

This prevents the debounce timer from being reset when parent re-renders with new inline `onSave` function.
