# 1.44 Adaptive Patient Context Panel

**Date:** December 17, 2024
**Status:** Complete

## Summary

Building an adaptive Patient Context panel that changes its content based on which SOAP section the practitioner is editing. The panel shows relevant contextual information (pain scores, vitals history, TCM patterns, treatment history) depending on focus.

## What Was Built

### Focus Tracking Infrastructure

**Modified `page.tsx`:**
- Added `focusedSection` state: `'subjective' | 'objective' | 'assessment' | 'plan' | null`
- Added `handleSectionFocus` and `handleSectionBlur` callbacks
- Pass these to SOAPSections component

**Modified `SOAPSections.tsx`:**
- Added `FocusedSection` type export
- Added `onSectionFocus` and `onSectionBlur` props
- Added `onBlur` handlers to all SOAP textareas

### PatientContextAdaptive Component

Created new adaptive panel at `src/components/custom/PatientContextAdaptive/`:

```
PatientContextAdaptive/
├── index.ts                    # Barrel exports
├── types.ts                    # Shared types (FocusedSection, ConditionStatus, etc.)
├── PatientContextAdaptive.tsx  # Main container with AnimatePresence transitions
├── DefaultContextView.tsx      # Shows when no section focused (current layout)
├── SubjectiveContextView.tsx   # Pain score timeline, past subjective notes
├── ObjectiveContextView.tsx    # Vitals history, tongue/pulse history
├── AssessmentContextView.tsx   # Editable conditions, TCM patterns, ICD-10 codes
├── PlanContextView.tsx         # Treatment history, protocols, past plans
└── components/
    ├── index.ts
    ├── ConditionRow.tsx        # Extracted from PatientContextLegacy
    └── SaveStatus.tsx          # Save indicator component
```

### Mock Data Helpers

Added to `src/data/mock/helpers.ts`:
- `getPatientSubjectiveHistory()` - Past subjective notes
- `getPatientObjectiveHistory()` - Past objective notes
- `getPatientAssessmentHistory()` - Past assessment notes
- `getPatientPlanHistory()` - Past plan notes
- `getPatientVitalsHistory()` - BP, HR extracted from objective
- `getPatientTonguePulseHistory()` - Tongue/pulse extracted from objective
- `getPatientTCMPatterns()` - TCM patterns used across visits
- `getPatientICDCodes()` - ICD-10 codes used
- `getPatientTreatmentHistory()` - Points used with duration/e-stim
- `getConditionPainScores()` - Pain scores for a condition over time

### Legacy Backup

- Renamed `PatientContext.tsx` → `PatientContextLegacy.tsx`
- Updated `custom/index.ts` to export from legacy file (maintains compatibility)

## Files Modified

| File | Changes |
|------|---------|
| `src/app/appointments/[id]/page.tsx` | Added focusedSection state and handlers |
| `src/app/appointments/[id]/components/SOAPSections.tsx` | Added onBlur, onSectionFocus, onSectionBlur |
| `src/app/appointments/[id]/components/index.ts` | Added FocusedSection export |
| `src/components/custom/index.ts` | Points to PatientContextLegacy |
| `src/data/mock/helpers.ts` | Added 10 new history helper functions |
| `src/data/mock/index.ts` | Exports new helpers and types |

## Files Created

| File | Purpose |
|------|---------|
| `src/components/custom/PatientContextAdaptive/index.ts` | Barrel exports |
| `src/components/custom/PatientContextAdaptive/types.ts` | Shared types |
| `src/components/custom/PatientContextAdaptive/PatientContextAdaptive.tsx` | Main container |
| `src/components/custom/PatientContextAdaptive/DefaultContextView.tsx` | Default view |
| `src/components/custom/PatientContextAdaptive/SubjectiveContextView.tsx` | Subjective focus view |
| `src/components/custom/PatientContextAdaptive/ObjectiveContextView.tsx` | Objective focus view |
| `src/components/custom/PatientContextAdaptive/AssessmentContextView.tsx` | Assessment focus view |
| `src/components/custom/PatientContextAdaptive/PlanContextView.tsx` | Plan focus view |
| `src/components/custom/PatientContextAdaptive/components/ConditionRow.tsx` | Condition status dropdown |
| `src/components/custom/PatientContextAdaptive/components/SaveStatus.tsx` | Save indicator |
| `src/components/custom/PatientContextAdaptive/components/index.ts` | Component barrel |

## Completed Work

### Wiring Complete (Session 2)

1. **Wire up PatientContextAdaptive in page.tsx** ✅
   - Replaced `PatientContext` import with `PatientContextAdaptive`
   - Passed `focusedSection`, `appointmentId`, `visitHistory` props
   - Added `?? []` fallback for `conditions` prop

2. **Build verification** ✅
   - `npm run build` passes with no TypeScript errors
   - All focus/blur transitions tested in browser

### Future Work (Deferred)

- **Quick Entry Bar** - Fixed bar above keyboard with context-specific buttons
- **Modals** - PainScoreModal, VitalsModal, AddConditionModal, etc.
- **iPad keyboard avoidance** - Use visualViewport API

## Key Patterns

### Focus Section Tracking

```typescript
// In page.tsx
const [focusedSection, setFocusedSection] = useState<FocusedSection>(null)

// In SOAPSections.tsx
<textarea
  onFocus={() => {
    onTextareaFocus(index)
    onSectionFocus?.(section.key)  // 'subjective' | 'objective' | etc.
  }}
  onBlur={() => {
    onSectionBlur?.()
  }}
/>
```

### View Switching Animation

```typescript
// In PatientContextAdaptive.tsx
<AnimatePresence mode="wait" initial={false}>
  <motion.div
    key={focusedSection || 'default'}
    initial={FADE_SLIDE_TRANSITION.initial}
    animate={FADE_SLIDE_TRANSITION.animate}
    exit={FADE_SLIDE_TRANSITION.exit}
  >
    {renderView()}
  </motion.div>
</AnimatePresence>
```

## Known Issues

None - all core functionality complete and working.

## Build Status

✅ Build passes as of session end

## Plan File

Full implementation plan saved at:
`/Users/timmyxie/.claude/plans/crystalline-conjuring-karp.md`
