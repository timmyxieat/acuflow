# Session 1.24: Panel Widths, Avatar Scaling, and URL Persistence

## Summary

This session focused on UI refinements: dynamic responsive widths for panels, avatar scaling, scroll consistency, status badge formatting, and URL query parameter persistence for selection state.

## What Was Built

### 1. Dynamic Panel Widths

Restored responsive width calculation for PatientCards and Middle Panel.

**Formula:** `clamp(180px, 20vw, 280px)`
- Minimum: 180px (small screens)
- Base: 20% of viewport width
- Maximum: 280px (large screens)

**Implementation:**
- Added `getExpandedWidth()` to `SIDEBAR_ANIMATION` in animations.ts
- Added `PANEL_WIDTH_CLASS` constant with CSS clamp
- Uses `useLayoutEffect` for resize handling
- Animations use dynamic pixel values calculated client-side

### 2. Dynamic Avatar Scaling

Patient header avatar now scales with viewport.

**Formula:** `clamp(32px, 2.5vw, 48px)`
- Small screens: 32px (matches PatientCards)
- Large screens: up to 48px

PatientCards avatars remain fixed at 32px for compact mode.

### 3. Scroll UI Consistency

Middle Panel ScrollableArea now matches PatientCards:
- Changed `py-4` to `py-3`
- Added `hideScrollbar` prop
- Consistent spacing between panels

### 4. Status Badge Formatting

AppointmentHeader status badge changed from pill/badge style to colored dot + black text:
```tsx
<div className="flex items-center gap-1.5">
  <div className="h-2.5 w-2.5 rounded-full" style={{ backgroundColor: statusColor }} />
  <span className="text-sm font-medium text-foreground">{statusDisplay.label}</span>
</div>
```

### 5. Fixed Compact PatientCards Width

Wrapped compact time display in fixed-width container to prevent width fluctuation:
```tsx
<motion.div className="w-8 overflow-hidden">
  <div className="flex items-center gap-0.5 text-[10px] text-muted-foreground whitespace-nowrap">
    {timeDisplay.text}
  </div>
</motion.div>
```

### 6. URL Query Parameter Persistence

Selection state now persists via URL query parameters.

**Today Screen (`/?selected=apt_001`):**
- Reads `?selected` param on mount
- Updates URL when selection changes via keyboard navigation
- Wrapped with Suspense for useSearchParams

**Appointment Detail (`/appointments/apt_001?preview=visit_003`):**
- Reads `?preview` param on mount
- Updates URL when visit preview is selected
- Falls back to most recent completed visit if no valid param

## Key Files Modified

| File | Changes |
|------|---------|
| `src/lib/animations.ts` | Added `getExpandedWidth()` function |
| `src/components/custom/TodayScreen.tsx` | Dynamic width, URL query params |
| `src/components/custom/PatientCards.tsx` | Fixed compact mode text width |
| `src/app/appointments/[id]/page.tsx` | Avatar scaling, scroll padding, status badge, URL params |
| `src/app/page.tsx` | Suspense wrapper for TodayScreen |

## Technical Details

### Responsive Width Pattern
```typescript
// In animations.ts
export const SIDEBAR_ANIMATION = {
  getExpandedWidth: () => {
    if (typeof window === 'undefined') return 200
    const vw20 = window.innerWidth * 0.2
    return Math.min(Math.max(vw20, 180), 280)
  },
  // ...
}

// In components
const PANEL_WIDTH_CLASS = 'w-[clamp(180px,20vw,280px)]'
const [expandedWidth, setExpandedWidth] = useState(SIDEBAR_ANIMATION.getExpandedWidth())

useLayoutEffect(() => {
  const updateWidth = () => setExpandedWidth(SIDEBAR_ANIMATION.getExpandedWidth())
  updateWidth()
  window.addEventListener('resize', updateWidth)
  return () => window.removeEventListener('resize', updateWidth)
}, [])
```

### URL Query Param Pattern
```typescript
const searchParams = useSearchParams()

// Read on mount
const previewFromUrl = searchParams.get('preview')

// Update URL without navigation
const updateUrlPreview = useCallback((visitId: string | null) => {
  const params = new URLSearchParams(searchParams.toString())
  if (visitId) params.set('preview', visitId)
  else params.delete('preview')
  router.replace(`/appointments/${appointmentId}?${params.toString()}`, { scroll: false })
}, [searchParams, router, appointmentId])
```

## Current State

All features are complete and functional:
- Panels resize smoothly with viewport
- Avatar scales proportionally
- Scroll behavior matches between panels
- Status badges use colored dot + black text
- Selection state persists across refresh and navigation

## No Known Issues

All acceptance criteria met. Build passes without errors.
