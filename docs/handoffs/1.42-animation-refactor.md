# 1.42 Animation Logic Refactor

**Date:** December 17, 2024
**Status:** Complete

## Summary

Refactored animation logic for the appointment detail page into centralized, well-documented modules. Fixed bugs where animations were incorrectly triggering for same-patient navigation and double-animating for different-patient navigation.

## What Changed

### Bug Fixes

1. **Visit History animating for same-patient navigation** - Fixed by:
   - Correcting `shouldAnimateMiddlePanel()` to check `!isSamePatientNavigation()` for both `appointment` and `scheduled` sources
   - Using conditional `initial={false}` when `shouldAnimate` is false

2. **Double animation for different-patient navigation** - Fixed by:
   - Replacing `Date.now()` in key generation with stable `patientId`
   - Key `header-left-${Date.now()}` caused new key on every re-render, triggering re-animation

### New Files Created

- **`src/app/appointments/[id]/lib/animation-config.ts`** - Centralized animation logic with:
  - Comprehensive documentation of key strategy and animation scenarios
  - `AnimationContext` and `AnimationConfig` types
  - `isSamePatientNavigation()` - core patient comparison logic
  - Section-specific config functions: `getHeaderLeftConfig()`, `getVisitHistoryConfig()`, etc.

- **`src/app/appointments/[id]/hooks/usePageAnimations.ts`** - Hook that:
  - Reads from TransitionContext
  - Computes animation configs for all page sections
  - Returns pre-computed configs for components

- **`src/app/appointments/[id]/hooks/index.ts`** - Barrel exports

### Modified Files

- **`AppointmentHeader.tsx`** - Now receives animation configs as props instead of calculating internally
- **`page.tsx`** - Uses `usePageAnimations` hook, applies conditional animation props

## Key Patterns Documented

### Key Strategy (determines static vs animate)

| Section        | Key Pattern                    | Result                                    |
|----------------|--------------------------------|-------------------------------------------|
| Header Left    | `patient-${patientId}`         | Static for same patient, animates for new |
| Visit History  | `patient-${patientId}`         | Static for same patient, animates for new |
| Header Center  | `appointment-${appointmentId}` | Always animates                           |
| SOAP Panel     | `${appointmentId}`             | Always animates                           |

### Animation Scenarios

| Scenario          | Left Section | Center/Right | Visit History | SOAP/Context |
|-------------------|--------------|--------------|---------------|--------------|
| From Today        | Slide right→ | Slide right→ | Slide right→  | Slide right→ |
| Same Patient      | Static       | Slide ↑↓     | Static        | Slide ↑↓     |
| Different Patient | Slide ↑↓     | Slide ↑↓     | Slide ↑↓      | Slide ↑↓     |

### Critical Pattern for AnimatePresence

```tsx
<AnimatePresence mode="wait" initial={shouldAnimate}>
  <motion.div
    key={stableOrChangingKey}
    initial={shouldAnimate ? animationValues : false}
    exit={shouldAnimate ? exitValues : undefined}
  />
</AnimatePresence>
```

When `shouldAnimate` is false:
- `initial={false}` skips initial animation
- `exit={undefined}` skips exit animation
- Stable key prevents remounting

## Current State

- Build passes ✅
- Same-patient navigation: Header left + Visit History stay static ✅
- Different-patient navigation: Single animation (no double) ✅
- From Today: Horizontal slide works ✅

## Known Issues

None.

## Files Reference

```
src/app/appointments/[id]/
├── page.tsx                    # Uses usePageAnimations hook
├── components/
│   └── AppointmentHeader.tsx   # Receives animation configs as props
├── hooks/
│   ├── index.ts                # Barrel exports
│   ├── useTimer.ts             # Timer state (unchanged)
│   └── usePageAnimations.ts    # NEW: Animation configs hook
└── lib/
    ├── helpers.ts              # Date helpers, constants
    └── animation-config.ts     # NEW: Centralized animation logic
```
