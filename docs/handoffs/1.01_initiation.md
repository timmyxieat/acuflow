# Handoff 1.01: Project Initiation & Schema Design

**Date:** December 9, 2025
**Status:** Schema complete, `.claude.md` update pending

---

## Summary

We completed a comprehensive product specification session for Acuflow, an acupuncture EHR SaaS. The database schema (`prisma/schema.prisma`) has been fully updated with all discussed models. The `.claude.md` file needs to be updated to reflect the new architecture decisions.

---

## What Was Completed

### 1. Product Specification Checklist
- Defined all core features, user flows, and domain models
- Established SaaS pricing tiers (Basic, Premium)
- Defined authentication strategy (Cognito + NextAuth.js v5)

### 2. AWS HIPAA Stack Decision
- **Hosting:** AWS Amplify (Next.js)
- **Database:** AWS RDS PostgreSQL
- **Auth:** AWS Cognito + NextAuth.js v5
- **Storage:** AWS S3 (documents, insurance cards)
- **SMS:** AWS SNS (~$1-8/mo per practitioner)
- **Email:** AWS SES
- **Monitoring:** AWS CloudWatch (audit logs)
- **Payments:** Stripe (separate BAA)
- **AWS BAA:** Already signed

### 3. Database Schema (Prisma 7)
Complete schema created at `prisma/schema.prisma` with:
- 22 models
- Clinic/Practitioner separation
- Three-layer patient health model
- Templates system
- HIPAA audit logging

---

## Key Architecture Decisions

### Clinic vs Practitioner Separation

**Before:** Practitioner had all practice info mixed in
**After:** Two separate entities

```
Clinic
├── name, address, phone, email, website
├── taxId (EIN for superbills)
├── bookingSlug (e.g., "wellness-acupuncture")
├── subscription (tier, status, Stripe IDs)
└── Owns: Practitioners, Patients, AppointmentTypes, FeeSchedule, TreatmentPackages, Templates

Practitioner
├── clinicId (belongs to clinic)
├── email, firstName, lastName, credentials
├── npiNumber, licenseNumber, licenseState (each has own NPI)
├── role: OWNER | ADMIN | PRACTITIONER
├── slug (for booking: ?practitioner=dr-smith)
└── Owns: Availability, BlockedTimes, Appointments, Protocols (personal)
```

### Three-Layer Patient Health Model

```
Layer 1: MEDICAL PROFILE (Background - JSON on Patient)
├── pastMedicalHistory, familyHistory, socialHistory
├── medications, allergies
├── emotionalStatus, tcmReviewOfSystems (10Qs)
└── Updated occasionally, not tracked per visit

Layer 2: ACTIVE CONDITIONS (PatientCondition table - tracked)
├── The patient's "problem list"
├── Examples: Low back pain, Tinnitus, Sleep issues, Hemorrhoids
├── Status: ACTIVE | IMPROVING | STABLE | RESOLVED
├── trackedMetrics: ["pain_score", "frequency"]
├── ConditionMeasurement: values over time
└── Lives on Patient, persists across visits

Layer 3: VISIT CHIEF COMPLAINTS (VisitChiefComplaint junction)
├── Which conditions are addressed TODAY
├── Subset of active conditions
├── isPrimary: main focus vs secondary
└── Links Visit to PatientCondition
```

### Template System

Templates allow quick data entry with `/trigger` syntax:

```
User types: /hemorrhoids

Template expands:
Protruding? |
Does it retract?
Is it bleeding?
Is there any pain?
Pain score (0-10)?
Stool consistency?

Navigation: Down arrow moves to next question
```

**Template model:**
- clinicId (required)
- practitionerId (NULL = clinic-wide, set = practitioner-specific)
- trigger: "/hemorrhoids"
- content: template text
- trackedFields: ["pain_score"] - auto-creates ConditionMeasurement

### SOAP Subsection Auto-Recognition

Practitioners type free-form, system recognizes known subsections:

```
Input:
Tongue: red body, thin white coating
Pulse: wiry, rapid, 84 bpm
BP: 128/82
Patient appears anxious but cooperative.

Stored JSON:
{
  "raw": "[full text]",
  "recognized": {
    "tongue": "red body, thin white coating",
    "pulse": "wiry, rapid, 84 bpm",
    "bp": "128/82"
  },
  "unstructured": "Patient appears anxious but cooperative."
}
```

### Booking URL Structure

```
/book/clinic-slug                     → Book with any practitioner
/book/clinic-slug?practitioner=dr-smith → Pre-selected practitioner
```

---

## Schema Models (22 total)

| Model | Purpose |
|-------|---------|
| Clinic | Practice entity (name, address, subscription) |
| Practitioner | Individual provider (NPI, role, availability) |
| PractitionerAvailability | Weekly schedule slots |
| BlockedTime | Vacation, lunch blocks |
| FeeScheduleItem | CPT codes with fees (clinic-level) |
| Patient | Demographics, insurance, medical profile JSON |
| PatientCondition | Problem list / active conditions |
| ConditionMeasurement | Tracked metrics over time |
| Document | S3 file references |
| AppointmentType | Initial, Follow-up, custom (clinic-level) |
| Appointment | Scheduled visits with status tracking |
| Visit | SOAP notes, treatment points |
| VisitChiefComplaint | Links visit to conditions addressed |
| TreatmentPoint | Points used in treatment |
| Point | Acupuncture point database |
| PointProtocol | Named point collections |
| ProtocolPoint | Points within a protocol |
| Template | /trigger templates |
| TreatmentPackage | Pre-paid bundles (clinic-level) |
| PatientPackage | Patient's purchased packages |
| Payment | Visit payments |
| Superbill | Insurance billing documents |
| HerbalFormula | Reference library |
| AuditLog | HIPAA compliance logging |

---

## Enums

```prisma
SubscriptionTier: BASIC, PREMIUM
SubscriptionStatus: ACTIVE, PAST_DUE, CANCELLED, TRIALING
PractitionerRole: OWNER, ADMIN, PRACTITIONER
AppointmentStatus: SCHEDULED, CHECKED_IN, IN_PROGRESS, COMPLETED, CANCELLED, NO_SHOW
DayOfWeek: MONDAY-SUNDAY
PointSide: BILATERAL, LEFT, RIGHT, CENTER, CONTRALATERAL, IPSILATERAL
NeedlingTechnique: TONIFYING, REDUCING, EVEN (removed NONE)
ProtocolSideType: FIXED, DYNAMIC
DocumentCategory: INSURANCE, IDENTIFICATION, INTAKE, CLINICAL, OTHER
BiologicalSex: MALE, FEMALE, OTHER
ConditionStatus: ACTIVE, IMPROVING, STABLE, RESOLVED
AuditAction: CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, EXPORT
```

---

## What Needs to Be Done

### Update `.claude.md` Key Domain Models Section

Replace the current "Key Domain Models" section with:

1. **Clinic** - New section describing the practice entity
2. **Practitioners** - Updated to show belongs-to-clinic relationship, roles
3. **Patient Health Model** - The three-layer explanation
4. **Active Conditions (PatientCondition)** - Problem list concept
5. **Templates** - The /trigger system
6. **Visit Chief Complaints** - How today's focus links to conditions
7. **SOAP Subsections** - Free-form with auto-recognition

### Update Other Sections

- **Online Booking** - Update URL structure to `/book/clinic-slug?practitioner=...`
- **Authentication** - Clarify Cognito pools (practitioners vs patients belong to clinic)

---

## Files Modified This Session

| File | Status |
|------|--------|
| `.claude.md` | Partially updated (needs Key Domain Models rewrite) |
| `prisma/schema.prisma` | Complete - all 22 models |
| `prisma.config.ts` | Complete - Prisma 7 config |

---

## User Preferences Captured

1. **Mobile editing:** Tap-to-edit full-screen modal (simple, not optimized UX)
2. **Point autocomplete:** Dropdown/combobox pattern
3. **Patient can see any practitioner** in the clinic
4. **Booking via query param** not separate practitioner URLs
5. **Templates:** Both clinic-wide and practitioner-specific
6. **Issue tracking:** Created from Chief Complaint, not auto-detected
7. **Conditions persist** on patient until explicitly resolved
8. **No 90-day auto-prompts** - only prompt when patient returns
9. **Sex field:** BiologicalSex enum (MALE, FEMALE, OTHER)
10. **AI is Phase 4+** - defer all AI infrastructure

---

## Next Steps

1. Update `.claude.md` Key Domain Models section with new architecture
2. Review updated `.claude.md` with user
3. Initialize Next.js project with tech stack
4. Begin Phase 1: Navigation structure and Today Screen

---

## Context for Continuation

The user is building Acuflow for their own acupuncture practice. They are:
- A practicing acupuncturist who will test everything personally
- Focused on eliminating "thinking about practice management"
- iPad-first (landscape, touch-optimized)
- Want tools that help without feeling heavy
- Strong opinions on UX (no clutter, right info at right time)

Design inspiration: Harvey.ai, Linear, Notion
