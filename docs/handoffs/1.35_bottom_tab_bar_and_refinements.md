# Session 1.35: Bottom Tab Bar and Refinements

## Summary

This session implemented a bottom tab bar for the appointment detail page with Medical/Billing/Comms tabs, enhanced both Billing and Comms tab content, and fixed several UI issues including hydration errors and animation refinements.

## What Was Built

### 1. Bottom Tab Bar with Status Previews

Added a 64px bottom tab bar to the appointment detail page that spans the SOAP + Patient Context area width.

**Three tabs with live status previews:**
- **Medical**: Shows appointment status with colored dot (e.g., "● In Progress")
- **Billing**: Shows amount and payment status (e.g., "$120 Due" or "$120 Paid")
- **Comms**: Shows confirmation status (e.g., "✓ Confirmed" or "Pending")

**Tab bar features:**
- Active tab has primary color + subtle background highlight
- Status previews update based on real appointment data
- FAB only appears on Medical tab

### 2. Enhanced Billing Tab (`BillingTab.tsx`)

Complete billing view with:
- **Payment Method Section**: Card on file with brand, last 4, expiry, or "Add Card" prompt
- **Today's Invoice**: Line items table with CPT codes, subtotal/tax/total, invoice status badge (Draft/Sent/Paid)
- **Payment Status**: Paid/Unpaid indicator with action buttons (Collect Payment, Mark as Paid)
- **Insurance Section**: Insurance info or self-pay indicator
- **Actions**: Generate Superbill, Email Receipt

### 3. Enhanced Comms Tab (`CommsTab.tsx`)

Combined communications with scheduling:
- **Messages sub-tab**: Message thread with reminder/confirmation timeline
- **Notes & Schedule sub-tab**:
  - Practitioner Notes (CRM-style notes)
  - This Appointment (current appointment info with Reschedule/Cancel)
  - Schedule Follow-up (recommended interval, quick-schedule button)
  - Recent Visits (list of past appointments)

### 4. Header Reorganization

- `AppointmentHeader` now accepts `activeTab` prop
- Right header section (Visits count) only shows on Medical tab
- Billing and Comms tabs get full-width content layout

### 5. Bug Fixes

- **Hydration errors**: Added `suppressHydrationWarning` to Timeline current time indicator and PatientCards timer spans
- **Chevron animation**: Fixed to only animate when collapsed state actually changes during navigation (not when already in same state)
- **Removed unsigned icon**: Removed amber minus icon from visit history cards
- **SOAP save status**: Conditionally render save status container only when there's a status to show

## Key Files Modified

| File | Changes |
|------|---------|
| `src/app/appointments/[id]/page.tsx` | Added tab state, mock billing/comms data, tab bar UI, header reorganization |
| `src/components/custom/BillingTab.tsx` | **NEW** - Complete billing tab component |
| `src/components/custom/CommsTab.tsx` | **NEW** - Complete comms tab with scheduling |
| `src/components/custom/PatientCards.tsx` | Chevron animation fix, hydration warning fix |
| `src/components/custom/Sidebar.tsx` | Pass collapsed state on back navigation |
| `src/components/custom/Timeline.tsx` | Hydration warning fix for current time indicator |
| `src/components/custom/TodayScreen.tsx` | Pass collapsed state on transition |
| `src/components/custom/index.ts` | Export new tab components |
| `src/contexts/TransitionContext.tsx` | Added `previousPatientCardsCollapsed` for animation decisions |

## Current State

- Bottom tab bar is functional with all three tabs
- Tab switching works smoothly
- Status previews reflect appointment data
- Billing tab shows payment method, invoice, payment status, insurance
- Comms tab shows messages, notes, and scheduling info
- FAB only appears on Medical tab
- All mock data is generated inline based on appointment status

## Pending Work / Known Issues

### High Priority

1. **Completed Appointment Viewing**: For completed appointments, the behavior should change:
   - No preview mode - you're viewing, not editing
   - Visit History should become navigation between visits
   - Selecting any visit should load that visit's full SOAP data (read-only)
   - Patient Context should update to show that visit's intake data
   - Today's completed and past completed appointments should look identical structurally

### Medium Priority

2. **Mock data to real data**: Billing and comms data are currently mocked inline. Need to:
   - Move to centralized mock-data.ts or connect to real backend
   - Add proper TypeScript interfaces to Prisma schema

3. **Tab actions are UI-only**: All action buttons (Collect Payment, Generate Superbill, Send Message, etc.) just exist as UI - no functionality yet

4. **Patient Context per-visit data**: Currently shows the same data regardless of which visit is selected. Should update based on selected visit.

### Low Priority

5. **Comms tab - message sending**: No actual message composition/sending UI
6. **Billing tab - add line item**: No UI for adding charges
7. **Animation refinements**: Some edge cases in tab switching animations

## Data Structures Added

### BillingData Interface
```typescript
interface BillingData {
  charges: ChargeItem[]
  subtotal: number
  tax: number
  totalCharges: number
  amountPaid: number
  balanceDue: number
  status: 'draft' | 'pending' | 'partial' | 'paid' | 'no_charges'
  invoiceStatus: 'draft' | 'sent' | 'paid'
  transactions: PaymentTransaction[]
  paymentMethod?: PaymentMethod
  insurance?: { company, memberId, groupNumber? }
}
```

### CommsData Interface
```typescript
interface CommsData {
  messages: Message[]
  notes: AppointmentNote[]
  confirmationStatus: ConfirmationStatus
  reminderSentAt?: Date
  confirmedAt?: Date
  unreadCount: number
  schedule: {
    currentAppointment: { date, startTime, endTime, type, duration, confirmedAt? }
    followUp?: { recommendedInterval, nextAvailable? }
    recentVisits: Array<{ date, type, status }>
  }
}
```

## Session Notes

- Tab type is defined inline in the component: `type TabType = 'medical' | 'billing' | 'comms'`
- Tab bar height is 64px to fit icon + label + status preview
- Billing and Comms tabs use `max-w-2xl` for readable content width
- Helper functions `getBillingStatusPreview` and `getCommsStatusPreview` are exported for tab bar previews
