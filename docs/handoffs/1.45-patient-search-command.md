# 1.45 Patient Search Command Palette

**Date:** December 17, 2024
**Status:** Complete

## Summary

Built a Spotlight-style command palette for searching patients. Opens globally via `⌘K` keyboard shortcut or by clicking the search button in the Topbar. Provides quick access to patients by name, phone, or condition with status-aware indicators.

## What Was Built

### SearchContext
- Global state for search open/close
- `useSearch()` hook for accessing `isOpen`, `openSearch`, `closeSearch`, `toggleSearch`

### PatientSearchCommand Component
- Command palette built on shadcn/ui `command` (cmdk library)
- Positioned near top of screen (20% from top) to avoid jumping when results change

**Empty State (no query):**
- "Recent" group - Last 3 patients from past visits (no today appointments)
- Divider line
- "Today" group - All today's appointments sorted by status priority

**Search Results (2+ characters):**
- Search by patient name (first, last, preferred)
- Search by phone number (with or without formatting)
- Search by condition name
- Groups results into "Today's Appointments" and "Other Patients"

**Result Item Display:**
- Avatar with status indicator dot (positioned at `top-[1px] right-[1px]`)
- Left side: Name, demographics (F, 40y), primary condition
- Right side: Status label (colored) + time for today's appointments

**Status Colors (matching existing system):**
| Status | Dot Color | Label Color |
|--------|-----------|-------------|
| In Progress | Blue `#3b82f6` | `text-blue-600` |
| Checked In | Green `#22c55e` | `text-green-600` |
| Scheduled | Slate `#94a3b8` | `text-slate-600` |
| Unsigned | Amber `#f59e0b` | `text-amber-600` |
| Completed | Slate `#94a3b8` | `text-slate-500` |

**Selection Behavior:**
- Today appointment → navigates to `/appointments/{id}`
- No today appointment → navigates to `/?patient={id}`

### Global Keyboard Handler
- `⌘K` / `Ctrl+K` opens palette from any screen
- Added in AppShell to ensure global availability
- TodayScreen keyboard handler checks `isSearchOpen` to avoid conflicts

### Simplified Topbar
- Removed inline search dropdown
- Simple button that triggers command palette via context
- Shows `⌘K` keyboard hint

### New Helper Functions

**`getRecentPatients(limit)`** in `helpers.ts`:
- Returns patients from recent visits (last 30 days) + today's patients
- Sorted by: today first (by status priority), then by most recent visit
- Returns `RecentPatient` objects with `patient`, `lastVisitDate`, `todayAppointment`

**`searchPatientsWithConditions(query)`**:
- Extends `searchPatients()` to also match condition names
- Returns patients sorted: today's first, then alphabetically

## Files Created

| File | Purpose |
|------|---------|
| `src/contexts/SearchContext.tsx` | Global open/close state |
| `src/components/custom/PatientSearchCommand.tsx` | Command palette component |
| `src/components/ui/dialog.tsx` | shadcn Dialog (via CLI) |
| `src/components/ui/command.tsx` | shadcn Command (via CLI) |

## Files Modified

| File | Changes |
|------|---------|
| `src/components/custom/AppShell.tsx` | Added SearchProvider, global ⌘K handler, renders PatientSearchCommand |
| `src/components/custom/Topbar.tsx` | Simplified to button that opens search via context |
| `src/components/custom/TodayScreen.tsx` | Added `isSearchOpen` check to keyboard handler |
| `src/components/custom/index.ts` | Exported PatientSearchCommand |
| `src/data/mock/helpers.ts` | Added `getRecentPatients`, `searchPatientsWithConditions`, `RecentPatient` type |
| `src/data/mock/index.ts` | Exported new functions and types |
| `src/components/ui/command.tsx` | Modified CommandDialog positioning (top-[20%]) |
| `package.json` / `yarn.lock` | Added cmdk dependency |

## Key Patterns

### Search Context Usage
```typescript
// In any component
const { openSearch, closeSearch, isOpen } = useSearch()

// Global keyboard shortcut (in AppShell)
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault()
      openSearch()
    }
  }
  document.addEventListener('keydown', handleKeyDown)
  return () => document.removeEventListener('keydown', handleKeyDown)
}, [openSearch])
```

### Avoiding Keyboard Conflicts
```typescript
// In TodayScreen keyboard handler
const handleKeyDown = useCallback((event: KeyboardEvent) => {
  // Don't handle when search dialog is open
  if (isSearchOpen) return
  const target = event.target as HTMLElement
  if (target.closest('[role="dialog"]')) return
  // ... rest of handler
}, [isSearchOpen, ...])
```

### Status-Aware Dot
```typescript
// Get color from existing system
const dotColor = getStatusColor(appointment.status, appointment.isSigned)

// Position on avatar edge
<div
  className="absolute top-[1px] right-[1px] h-2 w-2 rounded-full"
  style={{ backgroundColor: dotColor }}
/>
```

## Testing Checklist

- [x] `⌘K` opens palette from Today screen
- [x] `⌘K` opens palette from Appointment detail screen
- [x] Clicking Topbar search button opens palette
- [x] Search by full name returns correct patients
- [x] Search by partial name returns correct patients
- [x] Search by phone number works
- [x] Search by condition name works
- [x] Empty state shows Recent (3) + Today groups
- [x] Today group sorted by status priority
- [x] Results show correct status dot colors
- [x] Selecting patient with today appointment navigates to appointment
- [x] Selecting patient without today appointment navigates to Today with param
- [x] Arrow keys navigate results
- [x] Enter selects highlighted result
- [x] Escape closes palette
- [x] Clicking outside closes palette

## Known Issues

None - all core functionality complete and working.

## Build Status

✅ Build passes as of session end
