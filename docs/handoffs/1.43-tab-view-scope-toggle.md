# 1.43 Tab View Scope Toggle

**Date:** December 17, 2024
**Status:** Complete

## Summary

Added a "This Visit" / "All" segmented toggle to the Billing, Schedule, and Comms tabs on the appointment detail page. Each tab now has two views: one scoped to the current visit and one showing all patient history.

## What Changed

### New Files Created

- **`src/components/custom/SegmentedToggle.tsx`** - iOS-style segmented control component with:
  - Spring animation for indicator movement
  - `ViewScope` type (`'thisVisit' | 'all'`)
  - Reusable across all tabs

### Modified Files

**`src/data/mock-billing.ts`**
- Added `BillingHistoryInvoice` interface
- Added `PatientBillingHistory` interface
- Added `getPatientBillingHistory()` function with mock invoice history per patient

**`src/components/custom/BillingTab.tsx`**
- Added SegmentedToggle at top of header
- Split into `ThisVisitContent` and `AllBillingContent` components
- This Visit: Today's charges, payment collection button, outstanding balance summary
- All: All invoices list, total outstanding/paid, collect all button
- Both views have "Insurance info" and "Manage packages" links

**`src/components/custom/ScheduleTab.tsx`**
- Added SegmentedToggle at top of header
- Split into `ThisVisitContent` and `AllScheduleContent` components
- This Visit: This appointment details, follow-up section, book follow-up button
- All: Upcoming appointments, visit history, schedule appointment button
- Added `id` field to `RecentVisit` interface

**`src/components/custom/CommsTab.tsx`**
- Removed old Messages/Notes internal toggle
- Added SegmentedToggle at top of header
- Split into `ThisVisitContent` and `AllCommsContent` components
- This Visit: Confirmation status, messages/notes for this visit
- All: All messages, all notes (pinned first)
- Both views have Send Reminder / Send Intake Form buttons

**`src/app/appointments/[id]/page.tsx`**
- Added `viewScope` state (default: 'thisVisit')
- Added `billingHistory` data fetching via `getPatientBillingHistory()`
- Added `handleTabChange` callback that resets viewScope when switching tabs
- Added effect to reset viewScope when appointment changes
- Updated all tab components with `viewScope` and `onViewScopeChange` props

**`src/components/custom/index.ts`**
- Added exports for `SegmentedToggle`, `ViewScope`, `PatientBillingHistory`, `BillingHistoryInvoice`

## Key Patterns

### ViewScope State Management

```typescript
// In page.tsx
const [viewScope, setViewScope] = useState<ViewScope>('thisVisit')

// Reset when switching tabs
const handleTabChange = useCallback((tab: TabType) => {
  setActiveTab(tab)
  setViewScope('thisVisit')
}, [])

// Reset when appointment changes
useEffect(() => {
  setViewScope('thisVisit')
}, [appointmentId])
```

### Tab Component Props Pattern

```typescript
interface TabProps {
  appointmentId: string
  // ... existing data props
  viewScope: ViewScope
  onViewScopeChange: (scope: ViewScope) => void
}
```

### Crossfade Animation

```tsx
<AnimatePresence mode="wait" initial={false}>
  <motion.div
    key={viewScope}
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    exit={{ opacity: 0 }}
    transition={{ duration: 0.15 }}
  >
    {viewScope === 'thisVisit' ? <ThisVisitContent /> : <AllContent />}
  </motion.div>
</AnimatePresence>
```

## Current State

- Build passes ✅
- Toggle works on all three tabs (Billing, Schedule, Comms) ✅
- Toggle resets to "This Visit" when switching tabs ✅
- Toggle resets to "This Visit" when navigating to different appointment ✅
- Chart tab has no toggle (as per spec) ✅

## Known Issues

None.

## Out of Scope (for future)

- Slide-over panels for "Insurance info" and "Manage packages" links
- Filtering within "All" view (by date range, status)
- Bulk actions on "All" view
- Real data integration (currently using mock data)

## Files Reference

```
src/components/custom/
├── SegmentedToggle.tsx   # NEW: Reusable toggle component
├── BillingTab.tsx        # Updated with This Visit / All views
├── ScheduleTab.tsx       # Updated with This Visit / All views
├── CommsTab.tsx          # Updated with This Visit / All views
└── index.ts              # Added new exports

src/data/
└── mock-billing.ts       # Added billing history types and function

src/app/appointments/[id]/
└── page.tsx              # ViewScope state management
```
