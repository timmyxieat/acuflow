# 1.09 Appointment Detail Screen (Checkpoint 1)

## Session Summary

This session built the foundation for the Appointment Detail Screen - the main view where practitioners document visits. Completed checkpoint 1 (route, layout shell, navigation) plus layout refinements for contextual header.

## What Was Built

### 1. Appointment Detail Route (`/appointments/[id]`)

Two-column layout:
- **Left Panel (300px):** Patient header with avatar, name, sex, age + visit timeline placeholder
- **Right Panel (flex-1):** Appointment header with contextual countdown + SOAP sections placeholder

### 2. Contextual Global Header

The Topbar now changes based on route:

| Route | Header Content |
|-------|----------------|
| `/` (Today) | "Today · Friday, December 12" |
| `/appointments/[id]` | "← Em Johnson · 11:00 AM - 12:00 PM" |

Implemented via React Context (`HeaderContext`) that pages can set/reset.

### 3. Simplified Right Panel Header

Changed from two-line format to single line with contextual countdown:
- Before start: "Appointment today · in 5 minutes"
- During: "Appointment today · 15 min remaining"
- After end: "Appointment today · ended 10 min ago"

Updates every 30 seconds.

### 4. Action Button State Machine

- `SCHEDULED` → "Start Appointment"
- `IN_PROGRESS` → "End Appointment"
- `COMPLETED + unsigned` → "Sign Note"
- `COMPLETED + signed` → no button

### 5. "Open Full Record" Navigation

Wired up the button in AppointmentPreview to navigate to `/appointments/{id}`.

## Key Files

| File | Status | Description |
|------|--------|-------------|
| `src/app/appointments/[id]/page.tsx` | **New** | Appointment detail page with two-column layout |
| `src/contexts/HeaderContext.tsx` | **New** | Header context for route-aware global header |
| `src/components/custom/AppShell.tsx` | Modified | Added HeaderProvider wrapper |
| `src/components/custom/Topbar.tsx` | Modified | Reads from context, shows back button + patient info |
| `src/components/custom/AppointmentPreview.tsx` | Modified | Added router navigation to "Open Full Record" |

## Current State

**Working:**
- Navigation from Today → Appointment Detail → Back
- Contextual header that changes per route
- Status badges and action buttons display correctly
- Contextual countdown updates dynamically

**Placeholders (not yet implemented):**
- Visit Timeline (left panel) - shows "Visit timeline will appear here"
- Patient Intake section - collapsed stub
- SOAP sections - placeholder boxes

## Pending Work (Checkpoint 2-4)

Per the spec in `docs/prompts/sessions/1.09_start.md`:

1. **Checkpoint 2: Visit Timeline**
   - Create mock visit history data (3-5 past visits per patient)
   - Visit cards with date, chief complaint, appointment type icon, signed status
   - "Currently viewing" highlight state
   - Clicking card changes preview content in SOAP sections
   - Empty state for first-visit patients

2. **Checkpoint 3: SOAP Sections**
   - Editable textareas for each section
   - Preview lines below each section (read-only reference from selected past visit)
   - "Use past treatment" button in Plan section

3. **Checkpoint 4: Auto-Save**
   - Create `lib/api/visits.ts` with mock save functions
   - Create `useAutoSave` hook with debounce
   - "Saving..." → "Saved ✓" indicator

## Technical Notes

### HeaderContext Pattern

Uses `useCallback` and `useMemo` to prevent infinite re-render loops:

```tsx
const setHeader = useCallback((content: HeaderContent) => {
  setHeaderState(content)
}, [])

const value = useMemo(() => ({ header, setHeader, resetHeader }), [header, setHeader, resetHeader])
```

Pages set header in useEffect with `appointmentId` as the only dependency to avoid loops.

### Contextual Time Helper

`getContextualTimeStatus()` calculates time relative to appointment:
- Compares current time to `scheduledStart` and `scheduledEnd`
- Returns human-readable string like "in 5h" or "15 min remaining"

## Known Issues

None identified - all implemented features working correctly.

## Screenshots

Screenshots saved in `.playwright-mcp/`:
- `checkpoint1_appointment_detail.png` - Initial layout
- `checkpoint1_scheduled_state.png` - Scheduled appointment view
- `refinement_contextual_header.png` - Contextual header in action
