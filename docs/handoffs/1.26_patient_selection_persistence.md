# Session 1.26: Patient Selection Persistence Between Screens

## Summary

Fixed patient selection not persisting when navigating between the Today screen and Appointment detail screen. Previously, clicking "Back to Today" from an appointment would lose the patient selection.

## What Was Built

### URL-Based Patient Selection

Changed from appointment-based (`?selected=apt_001`) to patient-based (`?patient=pat_001`) URL params for selection persistence.

**Flow:**
1. User on Today screen clicks patient → URL becomes `/?patient=pat_001`
2. User clicks to view appointment → navigates to `/appointments/apt_001`
3. User clicks "Back to Today" → returns to `/?patient=pat_001`
4. Patient is still selected

### Header Context Enhancement

Added `currentPatientId` to HeaderContext so the back button knows which patient to preserve.

```typescript
interface HeaderContent {
  title?: string
  subtitle?: string
  showBackButton?: boolean
  currentPatientId?: string  // NEW: for back navigation
}
```

### Back Navigation

Updated all back navigation paths to use patient-aware URLs:
- Topbar "Back to Today" button
- ESC key handler in appointment detail
- Click-to-deselect in PatientCards

## Key Files Modified

| File | Changes |
|------|---------|
| `src/components/custom/TodayScreen.tsx` | Read/write `?patient` param; fixed selection update logic |
| `src/contexts/HeaderContext.tsx` | Added `currentPatientId` field |
| `src/components/custom/Topbar.tsx` | Back button uses patient-aware navigation |
| `src/app/appointments/[id]/page.tsx` | Sets `currentPatientId` in header; patient-aware back navigation |

## Technical Details

### TodayScreen URL Param Handling

```typescript
// Read patient from URL and select their appointment
useEffect(() => {
  const patientFromUrl = searchParams.get('patient')
  if (patientFromUrl) {
    const targetAppointmentId = getPatientTodayAppointmentId(patientFromUrl)
    if (targetAppointmentId && targetAppointmentId !== selectedAppointmentId) {
      setSelectedAppointmentId(targetAppointmentId)
    }
  }
}, [searchParams, selectedAppointmentId, setSelectedAppointmentId])

// Update URL when selection changes
const updateUrlSelection = useCallback((appointmentId: string | null, patientId?: string) => {
  const params = new URLSearchParams(searchParams.toString())
  if (patientId) {
    params.set('patient', patientId)
  } else {
    params.delete('patient')
  }
  router.replace(params.toString() ? `?${params.toString()}` : '/', { scroll: false })
}, [searchParams, router])
```

### Appointment Detail Back Navigation

```typescript
// In header setup
setHeader({
  showBackButton: true,
  currentPatientId: appointment.patient?.id,
})

// In Topbar back button
onClick={() => {
  if (header.currentPatientId) {
    router.push(`/?patient=${header.currentPatientId}`)
  } else {
    router.push('/')
  }
}}
```

## Bug Fix: Selection Override

Fixed an issue where navigating back wouldn't update selection if a different patient was previously selected. The original code only updated when `!selectedAppointmentId`, but now it compares appointment IDs and updates when they differ.

## Current State

All acceptance criteria met:
- Selecting patient on Today updates URL to `/?patient=<id>`
- Refreshing Today with `?patient` param restores selection
- Navigating to appointment and back preserves patient selection
- Back button navigates to `/?patient=<id>`
- Selection indicator highlights correct patient after returning

## No Known Issues

Build passes. All navigation paths tested.
