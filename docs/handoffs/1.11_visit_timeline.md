# 1.11 Visit Timeline (Checkpoint 2)

## Session Summary

Built the Visit Timeline feature for the appointment detail screen. This allows practitioners to see a patient's visit history and select past visits to preview their SOAP notes (preview functionality to be wired in next checkpoint).

## What Was Built/Changed

### 1. Mock Visit History Data

Created comprehensive mock data for patient visit history:

| Patient | # Past Visits | Chief Complaints |
|---------|---------------|------------------|
| Emily Johnson | 4 | Low back pain progression (8/10 → 3/10) |
| Robert Martinez | 3 | Right knee OA, HTN |
| Jennifer Lee | 2 | Migraines, neck tension |
| David Kim | 3 | Insomnia, tinnitus |
| Maria Garcia | 5 | Dysmenorrhea → fertility prep |
| Susan Brown | 2 | IBS-C, fatigue |
| William Davis | 1 | Right sciatica |
| James Thompson | 0 | (new patient - empty state) |

Each visit includes realistic SOAP note content with TCM diagnoses, treatment principles, and point prescriptions.

### 2. Visit Timeline Component

**Features:**
- Visit cards with date, chief complaint (extracted from subjective), appointment type icon, signed status
- "Currently viewing" highlight state when a card is selected
- Click to select, click again to deselect (toggle behavior)
- Empty state for new patients: "First visit for this patient"

**Icon mapping (consistent with Timeline.tsx):**
- Initial Consultation → `ClipboardCheck`
- Follow-up Treatment → `RefreshCw`
- Brief Follow-up → `Sparkles`
- Default → `Calendar`

Icons displayed as `text-muted-foreground/60` without colored backgrounds (matching Today page style).

### 3. Schema Update

Added `icon` field to `AppointmentType` model:
```prisma
icon String? // Lucide icon name (e.g., "clipboard-list", "repeat", "clock")
```

### 4. Other UI Improvements

- Added `cursor: pointer` to all buttons globally
- Added double-click handler prop to PatientCards (prep for future)
- Updated ideas.md with UX feedback notes

## Key Files Modified

| File | Changes |
|------|---------|
| `prisma/schema.prisma` | Added `icon` field to AppointmentType |
| `src/data/mock-data.ts` | Added `mockPastAppointments`, `mockVisits`, `getPatientVisitHistory()`, `getVisitById()`, `VisitWithAppointment` type |
| `src/app/appointments/[id]/page.tsx` | Built `VisitTimeline`, `VisitCard` components with selection state |
| `src/app/globals.css` | Added cursor:pointer to buttons |
| `src/components/custom/PatientCards.tsx` | Added `onAppointmentDoubleClick` prop |

## Current State

**Working:**
- Visit timeline displays past visits for each patient
- Cards are clickable with visual feedback
- "Currently viewing" highlight toggles correctly
- Empty state shows for new patients (James Thompson)
- Icons match Today page style
- No console errors

**Not yet wired:**
- Selecting a visit doesn't yet populate SOAP preview sections (Checkpoint 3)
- "Use past treatment" button functionality (Checkpoint 3)

## Pending Work (from 1.09 spec)

### Checkpoint 3: SOAP Sections
- Editable textareas for each SOAP section
- Preview lines below each section showing content from selected past visit
- "Use past treatment" button in Plan section to copy protocol

### Checkpoint 4: Auto-Save
- Create `lib/api/visits.ts` with mock save functions
- Create `useAutoSave` hook with debounce (1s delay)
- "Saving..." → "Saved ✓" indicator

## Technical Notes

### Visit Data Helper Functions

```typescript
// Get all visits for a patient (most recent first)
getPatientVisitHistory(patientId: string): VisitWithAppointment[]

// Get single visit by ID
getVisitById(visitId: string): VisitWithAppointment | null
```

### Chief Complaint Extraction

Chief complaints are extracted from the subjective field using:
1. Pattern match for "Chief complaint:" prefix
2. Fallback to first sentence (truncated to 50 chars)

### Selection State

Selection is managed in the page component with `useState<string | null>`:
- `null` = no visit selected
- `visitId` = that visit is highlighted with "Currently viewing"

## Known Issues

None currently.

## Files Created This Session

- `docs/handoffs/1.11_visit_timeline.md` (this file)
