# Handoff 1.02: Schema Refinement

**Date:** December 10, 2025
**Status:** Complete

---

## Summary

Comprehensive refinement of the database schema based on detailed UX and data flow discussions. Added new models for CRM notes, medical profile history, and split payment support. Updated existing models for better flexibility and automatic tracking.

---

## What Was Completed

### 1. Schema Changes

#### Removed
- `ProtocolSideType` enum (redundant - determined by ProtocolPoint.side values)
- `sideType` field from PointProtocol
- `practitionerNotes` from Appointment (consolidated into PatientNote)

#### Added New Enums
- `PaymentMethod`: CARD, HSA, FSA, CASH, CHECK, INSURANCE_PAYOUT, PACKAGE_CREDIT, OTHER
- `PaymentStatus`: PENDING, PARTIAL, PAID, REFUNDED, WRITTEN_OFF
- `MeasurementSource`: VISIT, PATIENT_INTAKE, SMS_FOLLOWUP, MANUAL
- `ProfileUpdateSource`: INITIAL_INTAKE, REEVALUATION_FORM, VISIT_UPDATE, PATIENT_PORTAL

#### Added New Models
- **PatientNote**: CRM-style rapport notes (isPinned, isPrivate)
- **MedicalProfileHistory**: Audit trail for Layer 1 medical profile changes
- **PaymentTransaction**: Individual payment events (supports split payments)

#### Modified Models
- **TreatmentPoint.technique**: Now nullable (null = no manipulation, which is most common)
- **ProtocolPoint.technique**: Now nullable
- **TreatmentPackage**: Added `practitionerId` for practitioner-specific packages
- **PatientPackage**: Added `restrictToPractitionerId` for usage restrictions
- **Payment**: Replaced old fields with `amountDue`, `status`, and `transactions` relation
- **Superbill**: Added `clearinghouseClaimId` for ERA matching
- **ConditionMeasurement**: Added `source` field for tracking measurement origin

### 2. Documentation Created

- **docs/specs/recognition-patterns.md**: Comprehensive guide for text recognition
  - Subjective section: condition matching, VAS score extraction
  - Plan section: point entry format, protocol triggers, autocomplete
  - Objective section: known subsection keywords
  - Data flow diagrams

- **prisma/seed.ts**: Default seed data
  - Standard acupuncture CPT codes with suggested fees
  - Default appointment types

### 3. Updated .claude.md

- Added Medical Profile History section
- Added Patient Notes (CRM) section
- Updated Payment Model with new structure
- Updated Treatment Packages for practitioner-specific support
- Updated Point Protocols with technique nullable info

---

## Key Architecture Decisions

### 1. Payment + Transaction Model

Instead of multiple Payment records per appointment, we use:
- One `Payment` per appointment (like an invoice)
- Multiple `PaymentTransaction` records for each payment event

**Why:** Cleaner status tracking, supports split payments, handles insurance payouts that arrive later.

### 2. Nullable Technique

`NeedlingTechnique` is now nullable on TreatmentPoint and ProtocolPoint:
- `null` = no manipulation (most common in practice)
- `TONIFYING`, `REDUCING`, `EVEN` for specific techniques

**Why:** Aligns with clinical reality where most points have no active manipulation.

### 3. Medical Profile History

Layer 1 medical profile changes are tracked automatically:
- Practitioner edits medications → history record created
- Links to visitId when changes happen during visit
- Source tracking (intake form vs visit update vs patient portal)

**Why:** HIPAA audit trail + ability to see "what changed when"

### 4. PatientNote for CRM

Single PatientNote table replaces practitionerNotes on Appointment:
- `isPinned`: Always visible (important reminders)
- `isPrivate`: Only author sees it (replaces old practitionerNotes use case)
- Lives on patient, grows over time

**Why:** Better rapport building, shared across practitioners in clinic

### 5. Text Recognition Approach

Practitioners type naturally, system extracts structure:
- Subjective → auto-links conditions, extracts VAS scores
- Plan → auto-creates TreatmentPoints from point codes

**Why:** Eliminates double-entry, keeps documentation natural

---

## Schema Model Count

| Category | Models |
|----------|--------|
| Clinic/Practitioner | 5 |
| Patient | 6 |
| Appointments/Visits | 5 |
| Points/Protocols | 4 |
| Templates | 1 |
| Packages/Payments | 4 |
| Superbills | 1 |
| Reference Data | 1 |
| Audit | 1 |
| **Total** | **28** |

---

## Files Modified This Session

| File | Status |
|------|--------|
| `prisma/schema.prisma` | Updated - all changes applied |
| `prisma/seed.ts` | Created - default seed data |
| `docs/specs/recognition-patterns.md` | Created - recognition documentation |
| `.claude.md` | Updated - architecture sections |
| `docs/output/1.02_schema_design_discussion.md` | Created - full discussion log |
| `docs/output/1.02b_schema_clarifications.md` | Created - clarifications |
| `docs/output/1.02c_final_decisions.md` | Created - final decisions |

---

## Deferred Features

1. **Gender-based point sides**: Discussed but deferred (revisit when needed)
2. **SMS follow-up for VAS**: Enum added, FollowUpRequest table deferred to premium
3. **treatmentSide field on Visit**: Handled purely in text entry UX

---

## Next Steps

1. Initialize Next.js project if not done
2. Generate Prisma client: `npx prisma generate`
3. Create initial migration: `npx prisma migrate dev --name init`
4. Begin Phase 1: Navigation structure and Today Screen
5. Implement point entry autocomplete UX

---

## Context for Continuation

The schema is now stable and comprehensive. Key patterns to remember:
- **Type naturally, extract structure**: UX philosophy
- **Technique defaults to null**: No manipulation is the default
- **Payment = invoice, Transaction = payment event**
- **PatientNote for CRM**: isPinned + isPrivate flags
- **Automatic status updates**: VAS trend drives condition status
