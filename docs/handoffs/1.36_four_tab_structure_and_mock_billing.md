# Session 1.36: Four-Tab Structure & Mock Billing Data Layer

## Summary

Restructured the appointment detail page from 3 tabs to 4 tabs (Medical | Billing | Schedule | Comms) and created a centralized mock billing data layer to demonstrate varied billing scenarios across different patients.

## What Was Built

### 1. Mock Billing Data Layer (`src/data/mock-billing.ts`)

Created a centralized billing data system with:

**Type Definitions:**
- `PaymentMethod` - Card/HSA/bank payment methods with brand, last4, expiry
- `PatientPaymentProfile` - Patient's saved payment methods and auto-pay setting
- `Invoice` / `InvoiceLineItem` - Invoice structure with CPT codes
- `PaymentTransaction` - Transaction history with success/failure status
- `BillingData` - Complete billing state for an appointment

**Mock Data Scenarios (by patient):**
| Patient | Scenario | Demonstrates |
|---------|----------|--------------|
| patient_001 | Paid via auto-pay | Happy path - card on file, auto-charged |
| patient_002 | Unpaid, no card | Needs to add card and collect payment |
| patient_003 | Failed payment | Card declined, needs resolution |
| patient_004 | Partial payment | Split payment scenario (HSA) |
| patient_005 | Unpaid with card | Card on file but needs manual collection |
| patient_006 | Paid manually | Multiple cards, paid with default |

**Helper Functions:**
- `getBillingDataForAppointment(appointmentId, patientId, isCompleted, usedEstim)`
- `getPatientPaymentProfile(patientId)`
- `getBillingStatusPreview(billingData)` - For tab bar preview

### 2. New Schedule Tab (`src/components/custom/ScheduleTab.tsx`)

Consolidated all scheduling info into a dedicated tab:

**Sections:**
- **This Appointment** - Date, time, duration, type, confirmation status, Reschedule/Cancel actions
- **Follow-Up** - Recommended interval, next available slot, quick book buttons
- **Upcoming Appointments** - Future appointments for this patient (or empty state)
- **Visit History** - Recent visits with "View All" action

**Preview Helper:**
- `getScheduleStatusPreview(scheduleData)` - Returns `{ text, color, icon }`

### 3. Updated Tab Structure

Changed from 3 tabs to 4:
```
Before: [ Medical ]  [ Billing ]  [ Comms ]
After:  [ Medical ]  [ Billing ]  [ Schedule ]  [ Comms ]
```

**Tab Bar Previews:**
| Tab | Icon | Preview Examples |
|-----|------|------------------|
| Medical | ClipboardCheck | `● In Progress`, `✓ Signed` |
| Billing | CreditCard | `$120 · Paid`, `$95 · Due`, `$120 · Failed` |
| Schedule | Calendar | `✓ Confirmed`, `Book follow-up` |
| Comms | MessageSquare | `✓ Confirmed`, `Pending`, `2 unread` |

### 4. Enhanced BillingTab

Updated to use the mock billing data layer with:
- **Payment Method section** - Shows card on file with auto-pay badge, or "Add Card" prompt
- **Today's Invoice** - Line items with CPT codes, quantities, totals
- **Payment Status** - Different UI states for paid/failed/unpaid/partial
- **Insurance section** - Carrier info or "Self-pay" indicator
- **Actions** - Generate Superbill, Email Receipt (enabled when paid)

### 5. Simplified CommsTab

Removed the schedule sub-tab (now a separate main tab):
- Messages section with thread view
- Notes section with pinned notes first
- Confirmation status badge in header

## Key Files Modified

| File | Changes |
|------|---------|
| `src/data/mock-billing.ts` | **NEW** - Billing types and mock data layer |
| `src/components/custom/ScheduleTab.tsx` | **NEW** - Schedule tab component |
| `src/components/custom/BillingTab.tsx` | Uses mock-billing data, enhanced UI for payment states |
| `src/components/custom/CommsTab.tsx` | Removed schedule sub-tab, simplified to Messages + Notes |
| `src/components/custom/index.ts` | Added ScheduleTab exports |
| `src/app/appointments/[id]/page.tsx` | 4-tab structure, scheduleData useMemo, updated tab bar |

## Current State

- **Working:** All 4 tabs functional with appropriate content
- **Working:** Different patients show different billing scenarios
- **Working:** Tab bar previews show correct status for each tab
- **Working:** Build passes with no TypeScript errors

## Technical Notes

### Tab Type Definition
```typescript
type TabType = 'medical' | 'billing' | 'schedule' | 'comms'
```

### Billing Data Flow
```
appointment.patient.id → getPatientScenario(patientId) → createBillingDataForScenario()
```

### Mock Patient Mapping
The mock billing scenarios are mapped by patient ID (patient_001 through patient_006). Patients not in the mapping default to 'unpaid_with_card' scenario.

## Pending Work

### High Priority
- [ ] **Connect to real data** - Replace mock billing data with actual database queries
- [ ] **Wire up action buttons** - Collect Payment, Mark as Paid, Retry Payment, etc.
- [ ] **Reschedule/Cancel modals** - Implement scheduling actions in Schedule tab

### Medium Priority
- [ ] **Add line item UI** - Modal for adding charges to invoice
- [ ] **Message sending** - Implement Send Message action in Comms tab
- [ ] **Add Note UI** - Modal for adding practitioner notes

### Low Priority
- [ ] **Email receipt integration** - Connect to email service
- [ ] **Superbill generation** - PDF generation for insurance
- [ ] **Visit history navigation** - Click to view past visit details

## Known Issues

None currently - all acceptance criteria met.

## Testing Notes

To see different billing scenarios, view appointments for different patients:
- In-progress patients will show draft/no charges state
- Completed patients will show their specific billing scenario based on patient ID

---

*Session 1.36 - December 16, 2024*
