# Acuflow - Development Guide for AI Assistants

This document provides context about the Acuflow project to help AI assistants understand our goals, architecture, and conventions.

## Project Mission

Acuflow is a modern acupuncture EHR (Electronic Health Records) SaaS application. Our mission is to eliminate practice management friction so acupuncturists can focus on patient care instead of software.

**Core Philosophy:** "Not having to think about practice management"

- Automate everything possible (booking, reminders, payments, documentation)
- Make clinical documentation fast and intuitive
- Provide acupuncture-specific tools (not a generic EHR)

**Target Users:** Solo acupuncture practitioners (expanding to multi-practitioner clinics)

**Primary Device:** iPad in landscape mode, touch-first interface

**Secondary Devices:**
- Desktop browsers (Chrome, Edge) for administrative tasks
- Mobile phones: **View-first with simple editing** - practitioners can view all sections; editing via tap-to-edit full-screen modal (not optimized UX, but functional)

### Mobile Editing Pattern

On mobile, text fields are not directly editable inline. Instead:
1. Tap any text block to open a full-screen modal
2. Modal contains a large textarea with the content
3. "Done" button saves and closes; "✕" cancels
4. Keyboard auto-opens for immediate typing
5. Simple and functional, not feature-rich

## SaaS Pricing Tiers

### Basic Tier
- Core EHR functionality
- Superbill generation for patient self-submission
- Online booking via personalized link
- SMS/Email reminders
- Payment processing (Stripe)

### Premium Tier
- Everything in Basic
- Direct insurance billing via clearinghouse API integration
- Advanced analytics and reporting
- Priority support

## Design Principles

### User Experience

- **Typing Shortcuts and Templates:** Use shortcuts for point protocols and templates to help speed up the intake process
- **Point Autocomplete:** Dropdown/combobox pattern - when typing points (e.g., "GB3"), show dropdown with all matching points (GB30, GB31, etc.) with point names for confirmation
- **Touch-optimized:** Minimum 44px tap targets, generous spacing between interactive elements
- **Fast workflows:** Common tasks should take seconds, not minutes
- **Intuitive navigation:** Users shouldn't need to think about where things are
- **Professional aesthetic:** Clean, spacious, inspired by Harvey.ai

### Visual Design

- Generous whitespace (24-32px between sections)
- Subtle shadows and light borders
- 8px rounded corners on cards and buttons
- Muted teal accents on neutral gray/white base
- Noto Sans font family with relaxed line-height

### Clinical Features

- **Point protocols:** Pre-configured acupuncture point combinations with needling methods
- **Multi-patient tracking:** Manage multiple patients simultaneously with timers
- **Smart organization:** Show needling points in logical order with location measurements
- **E-stim tracking:** Record whether electro-stimulation was used (affects CPT code selection)
- **Treatment timing:** Track needle retention time for accurate CPT unit calculation

## Technology Stack

### Overview

All-AWS infrastructure for simplified HIPAA compliance (single BAA covers all services).

```
┌─────────────────────────────────────────────────────────────┐
│                    PRODUCTION STACK                          │
├─────────────────────────────────────────────────────────────┤
│  Frontend + API    │  AWS Amplify Hosting (Next.js)         │
│  Database          │  AWS RDS PostgreSQL                     │
│  Auth              │  AWS Cognito + NextAuth.js v5           │
│  File Storage      │  AWS S3 (encrypted, signed URLs)        │
│  SMS               │  AWS SNS (~$1-8/mo per practitioner)    │
│  Email             │  AWS SES                                │
│  Monitoring        │  AWS CloudWatch (audit logs)            │
│  Payments          │  Stripe (separate BAA)                  │
│  Insurance         │  Clearinghouse API (premium tier)       │
└─────────────────────────────────────────────────────────────┘
```

### Core Technologies

- **Framework:** Next.js 16+ with App Router
- **Language:** TypeScript
- **Styling:** Tailwind CSS
- **UI Components:** shadcn/ui
- **Database:** PostgreSQL with Prisma 7 ORM
- **Forms:** React Hook Form with Zod validation
- **Animations:** Framer Motion

**Package Policy:** Always use the latest stable versions of all packages. When installing dependencies, use `@latest` tag or omit version to get the newest release. Check Context7 for current documentation when implementing features.

### AWS Infrastructure (HIPAA-Compliant)

| Service | Purpose | Notes |
|---------|---------|-------|
| **Amplify Hosting** | Next.js hosting | Full App Router support, API routes included |
| **RDS PostgreSQL** | Primary database | Encryption at rest, automated backups |
| **Cognito** | Identity/auth | Free tier (50k MAU), MFA support, HIPAA-eligible |
| **S3** | File storage | Insurance cards, documents, PDFs; SSE encryption |
| **SNS** | SMS notifications | ~$0.00645/SMS; est. $1-8/mo per practitioner |
| **SES** | Email | Appointment confirmations, reminders |
| **CloudWatch** | Monitoring/logs | HIPAA audit trail logging |

### Authentication Stack

- **AWS Cognito** as identity provider (handles user pools, MFA, password policies)
- **NextAuth.js v5** for session management in Next.js (Cognito provider)
- Separate user pools for practitioners vs. patients

### External Integrations

| Service | Purpose | BAA Status |
|---------|---------|------------|
| **Stripe** | Payment processing | Separate BAA required |
| **Clearinghouse** | Insurance claims (premium) | Separate BAA required |

### AI Infrastructure (Phase 4+)

AI features (smart SOAP notes, pattern suggestions) deferred to Phase 4+. When needed:
- **Primary option:** AWS Bedrock (managed, HIPAA-eligible, Claude/Llama available)
- **Alternative:** Self-hosted Llama on GPU EC2 (only if cost-effective at scale)

### Why This Stack

- **Single AWS BAA** - One agreement covers RDS, S3, Cognito, SNS, SES, CloudWatch, Amplify
- **Next.js unified codebase** - No separate Flask backend, faster iteration
- **Amplify over Vercel** - Native AWS integration, simpler compliance, adequate Next.js support
- **Cognito over custom auth** - Less code to audit, built-in HIPAA features
- **SNS over Twilio** - Already under AWS BAA, slightly cheaper

### Estimated Monthly Costs

| Stage | Services | Est. Cost |
|-------|----------|-----------|
| **Development** | Amplify (free tier), RDS (db.t3.micro), Cognito (free), minimal S3/SNS | ~$15-25/mo |
| **Production (1 practitioner, ~100 patients)** | All services at low usage | ~$80-150/mo |

*Plus Stripe transaction fees (2.9% + $0.30 per charge)*

## Project Structure

```
/app
  /...authenticated routes          # Main authenticated application
  /login & /signup                  # Practitioner auth (Cognito)
  /patient/login                    # Patient auth (Cognito magic link)
  /book/[clinic-slug]               # Public booking page (?practitioner=slug optional)
  /api                              # Backend API routes
/components
  /ui                # shadcn/ui components
  /custom            # Custom application components
/lib
  /utils             # Utility functions
  /hooks             # Custom React hooks
  /aws               # AWS SDK utilities (S3, SNS, etc.)
  /db                # Prisma client instance
/data
  /mock-data.ts      # Development mock data
  /points.ts         # Acupuncture point database (provided by user)
/docs
  /specs             # Feature specifications
/prisma
  /schema.prisma     # Database schema (Prisma 7)
  /migrations        # Database migrations
  /seed.ts           # Seed data script
prisma.config.ts     # Prisma 7 configuration (datasource URL, migrations)
```

## Key Domain Models

### Clinic

The practice entity that owns all resources:

- **Practice Info:** name, address, phone, email, website
- **Billing:** taxId (EIN for superbills)
- **Booking:** bookingSlug (e.g., "wellness-acupuncture") for `/book/clinic-slug`
- **Subscription:** tier (BASIC, PREMIUM), status, Stripe IDs
- **Owns:** Practitioners, Patients, AppointmentTypes, FeeSchedule, TreatmentPackages, Templates (clinic-wide)

### Practitioners

Belong to a clinic, each with their own credentials:

- **clinicId:** belongs to one clinic
- **Profile:** email, firstName, lastName, credentials
- **Licensing:** npiNumber, licenseNumber, licenseState (each practitioner has own NPI)
- **Role:** OWNER | ADMIN | PRACTITIONER
- **Booking:** slug (for booking: `?practitioner=dr-smith`)
- **Owns:** Availability, BlockedTimes, Appointments, Protocols (personal), Templates (personal)
- Patients can see any practitioner in the clinic

### Patient Health Model (Three Layers)

```
Layer 1: MEDICAL PROFILE (Background - JSON on Patient)
├── pastMedicalHistory, familyHistory, socialHistory
├── medications, allergies
├── emotionalStatus, tcmReviewOfSystems (10Qs)
└── Updated occasionally, not tracked per visit

Layer 2: ACTIVE CONDITIONS (PatientCondition table - tracked)
├── The patient's "problem list"
├── Examples: Low back pain, Tinnitus, Sleep issues, Hemorrhoids
├── Status: ACTIVE | IMPROVING | STABLE | RESOLVED
├── trackedMetrics: ["pain_score", "frequency"]
├── ConditionMeasurement: values over time
└── Lives on Patient, persists across visits

Layer 3: VISIT CHIEF COMPLAINTS (VisitChiefComplaint junction)
├── Which conditions are addressed TODAY
├── Subset of active conditions
├── isPrimary: main focus vs secondary
└── Links Visit to PatientCondition
```

### Active Conditions (PatientCondition)

The patient's "problem list" - conditions being actively tracked:

- Created when practitioner identifies an issue (from Chief Complaint)
- Status tracking: ACTIVE → IMPROVING → WORSENING → STABLE → RESOLVED
- **trackedMetrics:** Array of metrics to track (e.g., `["pain_score", "frequency"]`)
- **ConditionMeasurement:** Records values over time (linked to visits, with source tracking)
- **Automatic status updates:** Status auto-updates based on VAS trend (practitioner only needs to mark RESOLVED)
- Persists until explicitly resolved (no auto-prompts)

### Medical Profile History

Tracks changes to Layer 1 medical profile fields over time:

- **MedicalProfileHistory** table records all changes
- Links to visitId when changes happen during a visit
- Tracks section, changeType, changeDescription
- Stores previousValue and newValue for audit
- Source tracking: INITIAL_INTAKE, REEVALUATION_FORM, VISIT_UPDATE, PATIENT_PORTAL
- Practitioner doesn't "manage" history - it just happens on save

### Patient Notes (CRM)

Rapport-building notes that persist across visits:

- **PatientNote** table for relationship notes
- Examples: "Visiting daughter in Arizona", "Prefers afternoon appointments"
- **isPinned:** Always show at top (important reminders like "needle-sensitive")
- **isPrivate:** Only author sees it
- Can be added during visit or from patient profile
- UX: Highlight text in SOAP note → mark as quick note

### Templates

Quick data entry with `/trigger` syntax:

```
User types: /hemorrhoids

Template expands:
Protruding? |
Does it retract?
Is it bleeding?
Is there any pain?
Pain score (0-10)?
Stool consistency?

Navigation: Down arrow moves to next question
```

**Template ownership:**
- `clinicId` (required) - all templates belong to a clinic
- `practitionerId` (NULL = clinic-wide, set = practitioner-specific)
- `trigger`: "/hemorrhoids"
- `content`: template text with questions
- `trackedFields`: ["pain_score"] - auto-creates ConditionMeasurement

### Visit Chief Complaints

Links a visit to the conditions being addressed that day:

- **VisitChiefComplaint** junction table connects Visit → PatientCondition
- **isPrimary:** Distinguishes main focus from secondary concerns
- Subset of patient's active conditions
- Drives what appears in today's SOAP note

### SOAP Subsections (Auto-Recognition)

Practitioners type free-form, system recognizes known subsections:

```
Input:
Tongue: red body, thin white coating
Pulse: wiry, rapid, 84 bpm
BP: 128/82
Patient appears anxious but cooperative.

Stored JSON:
{
  "raw": "[full text]",
  "recognized": {
    "tongue": "red body, thin white coating",
    "pulse": "wiry, rapid, 84 bpm",
    "bp": "128/82"
  },
  "unstructured": "Patient appears anxious but cooperative."
}
```

Known subsection keywords vary by SOAP section (Tongue, Pulse, BP for Objective, etc.)

### Appointment Types

Standard types (practitioner can customize):
- **Initial Consultation:** ~90 minutes (new patient intake + treatment)
- **Follow-up:** ~60 minutes (returning patient treatment)

Practitioners can add custom types with custom durations.

### Appointments

- Represents scheduled time slots with patients
- Links to an appointment type (determines duration)
- States for main lifecycle: scheduled → checked_in → in_progress → completed
- Other States: cancelled, no_show
  - Tracking whether patients are late for their appointment (determined at checked_in state)
  - late and no_show can be assigned manually
  - no_show is automatically assigned after 1 hour the appointment start time if not checked_in
- On the home screen, patient cards are shown in the following categories ordered below:
  1. in_progress
  2. checked_in
  3. scheduled
  4. unsigned (state is completed and is_signed is false)
  5. completed (completed and is_signed is true)
  6. cancelled and no_show grouped together
- Tracks timing for multi-patient management
- **Treatment duration tracking** for CPT unit calculation

### Visits

- Completed appointments with clinical documentation
- Contains SOAP note (Chief Complaint, Subjective, Objective, Assessment, Plan)
- Before the appointment, patients are prompted to fill out their pre-appointment paperwork
  - Sections include Past Medical History (PMH), Family History (FH), Social History (SH), Emotional Status (ES), TCM Review of Systems (10 Questions - 10Qs for short)
  - During the appointment, the practitioner can easily update these sections
- Within each SOAP note section, it can further be broken down into subsections. For example:
  - Subjective can contain Chief Complaint (CC), History of Present Illness (HPI), and any section
  - Objective can contain Tongue, Pulse, Channel Palpation, Physical Examination
  - Assessment can be broken down into TCM Pattern and ICD-10 Codes
  - Plan can contain Treatment Principle, Acupuncture, Herbal Medicine, Adjunct Therapies, Lifestyle Recommendations, Follow-up Plan
- Under Acupuncture the practitioner can easily record an acupuncture protocol that consist of points with their manipulation method and side of the body they were inserted into.
- **E-stim flag:** Whether electro-stimulation was used (for CPT code selection: 97810/97811 vs 97813/97814)

### Point Protocols

- Named collections of acupuncture points
- Each point in protocol has: side, technique (nullable = no manipulation)
- **Fixed sides:** BILATERAL, LEFT, RIGHT, CENTER
- **Dynamic sides:** CONTRALATERAL, IPSILATERAL (resolved when protocol is applied)
- Point sides can be overridden when used during treatment
- Technique defaults to null (no manipulation); can override with TONIFYING, REDUCING, EVEN
- Can be practitioner-specific or clinic-wide, optionally shared

### Point Database

- **User will provide** the acupuncture point database including:
  - Standard acupuncture points (all meridians)
  - Master Tung points
- Each point includes: code, name, location description, cun measurements

### Point Reference during Treatment (Treatment Mode)

- Points are organized in a logical needling sequence
- Quick reference for point manipulation method, side, and location (cun measurements)

### Treatment Packages

- Pre-paid bundles (e.g., "10 treatments for $800") → adds credits to patient's balance
- **TreatmentPackage:** Can be clinic-wide or practitioner-specific
- **PatientPackage:** Patient's purchased package, with optional practitioner restriction
- Auto-deduct credits on each visit
- Optional expiration dates

### Patients

- Core demographic and contact information
- Payment methods (Stripe customer ID for card on file) - **collected at booking/intake**
- Insurance information:
  - Text fields: company name, member ID, group number
  - Insurance card images (front/back) - stored in S3
- A living history of the pre-appointment paperwork sections such as Past Medical History (PMH), Family History (FH), Social History (SH), Emotional Status (ES), TCM Review of Systems (10 Questions - 10Qs for short)
- Credit balance (from treatment packages)
- Document storage (insurance cards, intake forms, any uploaded PDFs/images) - stored in S3 with signed URLs

### Superbills

- Generated per visit for insurance reimbursement
- Contains:
  - Provider info (name, NPI, license, tax ID, address)
  - Patient info (name, DOB, insurance details)
  - Date of service, place of service code (11 = office)
  - ICD-10 diagnosis codes (from Assessment)
  - CPT procedure codes with units (auto-calculated from treatment duration and e-stim flag)
  - Fees and totals
- PDF export for patient self-submission (basic tier)
- Electronic submission via clearinghouse (premium tier)

### Herbal Medicine Reference

- Reference library of common herbal formulas (names only)
- Not tracking inventory, dispensing, or detailed formula composition
- Future consideration for more detailed tracking

## Authentication

### Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                  AUTHENTICATION FLOW                         │
├─────────────────────────────────────────────────────────────┤
│  Practitioner                    Patient                     │
│  ─────────────                   ───────                     │
│  /login                          /patient/login              │
│       ↓                               ↓                      │
│  Cognito User Pool              Cognito User Pool            │
│  (email + password + MFA)       (email + magic link)         │
│       ↓                               ↓                      │
│  NextAuth.js v5 Session         NextAuth.js v5 Session       │
│  (15 min timeout)               (1 week w/ remember me)      │
│       ↓                               ↓                      │
│  Full EHR Access                Limited Patient Portal       │
└─────────────────────────────────────────────────────────────┘
```

### Separate Entry Points

| Aspect | Practitioner | Patient |
|--------|--------------|---------|
| **URL** | `/login` | `/patient/login` |
| **Auth method** | Email + password (+ MFA option) | Email + magic link |
| **Account creation** | Self-signup or invite | Auto-created at booking/intake |
| **Session duration** | 15 min timeout (HIPAA) | 1 week with "remember me" |
| **Access** | Full EHR dashboard | Limited patient portal |

### Why Separate User Pools
- Different security requirements (MFA for practitioners)
- Different session policies
- Cleaner Cognito configuration
- Patients get simpler passwordless flow
- Both practitioners and patients belong to a clinic (clinicId on their records)

## Patient Portal (Limited Self-Service)

Patients can access limited functionality:

**Without Login:**
- Book appointments via practitioner's personalized link
- Fill out pre-appointment paperwork

**With Login:**
- View/edit/cancel their appointments
- View visit history (limited)
- Update contact information
- Update payment information
- Download superbills

## Online Booking

**Core early feature** (not future/widget-based)

**URL Structure:**
```
/book/clinic-slug                        → Book with any practitioner
/book/clinic-slug?practitioner=dr-smith  → Pre-selected practitioner
```

- Each clinic gets a booking link via their `bookingSlug`
- Practitioners can be pre-selected via query param (their `slug`)
- Patients can book without creating an account
- Shows available time slots based on selected practitioner(s) schedule
- Respects blocked times
- Collects basic contact info + payment method
- Sends confirmation via email (SES) and SMS (SNS)
- New patients prompted to complete intake forms

### Practitioner Availability

- Set weekly recurring schedule (e.g., Mon/Wed/Fri 9am-5pm, Tue/Thu 10am-7pm)
- Block off specific dates/times (vacations, lunch breaks, etc.)
- Appointment types determine slot durations

## Payment Model

### Structure
- **Payment:** One per appointment, like an invoice. Tracks amountDue and status.
- **PaymentTransaction:** Individual payment events (can be multiple per Payment)

### Payment Methods
CARD, HSA, FSA, CASH, CHECK, INSURANCE_PAYOUT, PACKAGE_CREDIT, OTHER

### Payment Statuses
PENDING, PARTIAL, PAID, REFUNDED, WRITTEN_OFF

### Happy Path Flow
1. **At booking/intake:** Patient provides credit card (stored via Stripe)
2. **During appointment:** Treatment happens, no payment action needed
3. **At end of appointment:** Card auto-charged → PaymentTransaction created
4. **Alternative:** If patient has credits (from package), deduct credit instead
5. **Split payments:** Multiple transactions on one Payment (e.g., copay + insurance later)

### Insurance Payout (Premium Tier)
- Clearinghouse receives 835/ERA from insurance
- System auto-posts PaymentTransaction with method: INSURANCE_PAYOUT
- Status updates automatically when fully paid

All settings are defaults that practitioners can customize.

## Development Approach

### Build Philosophy: "Shell First, Then Details"

1. Build screen layouts and navigation structure
2. Add basic interactivity and data flow
3. Implement intelligent features
4. Polish and optimize

**Rationale:** See the big picture early, iterate on working features, avoid building wrong things

### Iteration Strategy: "One Component at a Time"

- Focus on one feature or component per session
- Get it working and visually right before moving on

**Rationale:** Easier to debug, clearer progress

### Git Commits

- **Don't commit after every small change** - wait for meaningful checkpoints
- **Do commit when:**
  - User explicitly asks
  - A feature or component is finalized and working (no known bugs)
  - Significant work would be lost if the session ended
- **Use discretion** - if unsure, ask before committing
- Write clear, descriptive commit messages summarizing what changed

### Authentication Strategy: "Auth Late"

- Development mode uses stubbed user (Dr. Dev)
- Real Cognito authentication added when needed for deployment
- Avoids login friction during rapid development

**Rationale:** Faster iteration, easier testing, auth complexity comes when it matters

## Code Conventions

### Component Organization

- Functional components only (no class components)
- TypeScript interfaces for all props
- Co-locate related logic with components
- Export components as named exports

### File Naming

- Components: `PascalCase.tsx`
- Utilities: `camelCase.ts`
- Types: `PascalCase.ts` or in component files
- Pages: Next.js conventions (`page.tsx`, `layout.tsx`)

### Styling Approach

- Tailwind utility classes for all styling
- Use `cn()` utility from `lib/utils` for conditional classes
- Avoid inline styles (exception: dynamic colors using status hex values)
- Touch targets: minimum `h-11` (44px) for tappable elements
- **Spacing in lists:** Prefer `flex flex-col gap-*` or `grid gap-*` over individual margins (`mb-*`, `space-y-*`) for consistent spacing between items

### Time Formatting (Hydration-Safe)

Use `formatTime()` from `src/lib/dev-time.ts` instead of `toLocaleTimeString()` to avoid hydration mismatches:

```typescript
import { formatTime } from '@/lib/dev-time'

// Returns "9:30 AM" format consistently on server and client
formatTime(appointment.scheduledStart)
```

### ScrollableArea Component

Use `ScrollableArea` for scrollable containers that need fade indicators:

```typescript
import { ScrollableArea } from '@/components/custom'

<ScrollableArea className="p-4 space-y-3" deps={[dataToWatch]}>
  {/* content */}
</ScrollableArea>
```

- Shows top/bottom gradient fade when content is scrollable
- `deps` array triggers re-check when data changes (like useEffect deps)

### Status Colors

Use centralized status colors from `src/lib/constants.ts`:

```typescript
import { getStatusColor } from '@/lib/constants'

// Returns hex color for inline styles
const color = getStatusColor(appointment.status, appointment.isSigned)
```

| Status | Color | Hex |
|--------|-------|-----|
| In Progress | Blue | `#3b82f6` |
| Checked In | Green | `#22c55e` |
| Scheduled | Yellow | `#eab308` |
| Unsigned | Amber | `#f59e0b` |
| Completed | Slate | `#94a3b8` |

### TypeScript Usage

- Prefer interfaces over types for object shapes
- Type all function parameters and returns
- Use `type` for unions and primitives
- Avoid `any` - use `unknown` if type is truly unknown

### Using Prisma Types (IMPORTANT)

**Always use Prisma-generated types instead of manually defining types for database entities.**

Prisma generates types automatically from the schema. These are the single source of truth:

```typescript
// ✅ CORRECT - Import from Prisma generated client
import type {
  Clinic,
  Patient,
  Appointment,
  PatientCondition,
} from '@/generated/prisma/client'

import {
  AppointmentStatus,
  ConditionStatus,
  BiologicalSex,
} from '@/generated/prisma/client'

// ❌ WRONG - Don't manually redefine types that Prisma generates
type AppointmentStatus = 'SCHEDULED' | 'CHECKED_IN' | ... // Don't do this!
interface Patient { ... } // Don't do this!
```

**Why this matters:**
- Single source of truth - schema changes automatically update types
- No brittle code - manual types can get out of sync with the database
- Better IDE support - Prisma types include all relations and fields

**What Prisma exports:**
- Model types: `Clinic`, `Patient`, `Appointment`, `Visit`, etc.
- Enum types: `AppointmentStatus`, `ConditionStatus`, `BiologicalSex`, etc.
- Input types: `PatientCreateInput`, `AppointmentWhereInput`, etc.

### Documentation Best Practices

**Always check the latest documentation before implementing features.**

When using any library, framework, or tool:

1. **Use Context7 MCP** to fetch up-to-date documentation for the exact version being used
2. **Check for breaking changes** when using newer versions of libraries
3. **Follow official patterns** - don't rely on outdated tutorials or assumptions
4. **Verify API signatures** - function parameters and return types may have changed

This is especially important for:
- Prisma (API changes between major versions)
- Next.js (App Router vs Pages Router patterns)
- shadcn/ui (component APIs and installation)
- React (hooks patterns, server components)

### Best Coding Practices

Follow these essential practices for every task:

**Project Setup:**
- Always include `.gitignore` with appropriate entries for Node.js, Next.js, env files, and IDE files
- Create `.env.example` with all required environment variables (never commit actual secrets)
- Maintain proper project structure as defined in this document

**Code Quality:**
- Write clean, readable code with meaningful variable and function names
- Keep functions small and focused (single responsibility)
- Use early returns to reduce nesting
- Add JSDoc comments for complex functions and public APIs
- Handle errors gracefully with proper error boundaries and try/catch blocks

**Security:**
- Never commit secrets, API keys, or credentials
- Validate and sanitize all user inputs
- Use parameterized queries (Prisma handles this)
- Implement proper authentication and authorization checks
- Follow OWASP guidelines for web security

**Performance:**
- Use React Server Components where possible
- Implement proper loading states and Suspense boundaries
- Optimize images and assets
- Use proper caching strategies

**Testing & Reliability:**
- Write defensive code that handles edge cases
- Log errors appropriately for debugging
- Use TypeScript strict mode to catch issues early

## Acupuncture Domain Knowledge

### Point Naming Convention

Format: `AB##` where AB is meridian abbreviation, ## is point number

- Examples: `LI4` (Large Intestine 4), `ST36` (Stomach 36), `DU20` (Du 20)
- Meridian abbreviations are shown below:
  - LU, SP, ST, LI, HT, SI, BL, KD, PC, SJ, GB, LV, RN, DU

### Needling Techniques

- **Tonifying:** Strengthening/supplementing (clockwise, insert slow/remove fast)
- **Reducing:** Draining/sedating (counterclockwise, insert fast/remove slow)
- **Even:** Neutral technique
- **None:** No manipulation after insertion

### Point Sides

- **Bilateral:** Both sides
- **Center**: For points that are on the midline (e.g. Yintang, RN and DU points)
- **Left/Right:** Specific side
- **Contralateral/Ipsilateral:** for dynamic sides in point templates

### Body Regions for Organization

- Head, Neck, Back, Chest, Abdomen, Upper Extremity, Lower Extremity
- This is the order I needle for upper extremity for face up treatments
  1. HT
  2. PC
  3. LU
  4. LI
  5. SJ
  6. SI
- This is the order I needle for lower extremity for Face up treatments
  1. KD
  2. SP
  3. LV
  4. BL
  5. GB
  6. ST
- Organize needling by region for efficiency
- Consider front/back positioning for needling feasibility

### CPT Codes for Acupuncture

| CPT Code | Description | When to Use |
|----------|-------------|-------------|
| 97810 | Acupuncture, 1+ needles, without e-stim, initial 15 min | Always first (no e-stim) |
| 97811 | Each additional 15 min without e-stim | Add-on to 97810 |
| 97813 | Acupuncture, 1+ needles, with e-stim, initial 15 min | Always first (with e-stim) |
| 97814 | Each additional 15 min with e-stim | Add-on to 97813 |
| 97140 | Manual therapy | Tui na, cupping |

### SOAP Note Format

- **Subjective:** Patient-reported symptoms and history
- **Objective:** Practitioner observations (tongue, pulse, physical exam)
- **Assessment:** TCM pattern diagnosis + ICD-10 codes
- **Plan:** Treatment approach and points selected

## Common Workflows

### Typical Appointment Flow

1. Patient books online via personalized link (provides payment method)
2. Automated reminder sent 24 hours before (via SNS + SES)
3. Patient checks in on tablet (or staff checks in)
4. Practitioner reviews patient history
5. Practitioner starts appointment (timer begins for tracking)
6. Document SOAP note during/after treatment
7. Add points from protocol or manually
8. Needle patient (20-minute rest timer)
9. Remove needles
10. Patient leaves the appointment room and practitioner hits "End Appointment" with option to set is_signed to true or false. This makes the appointment state to completed
11. Auto-charge card on file via Stripe (or deduct credit from package)
12. Patient schedules next appointment
13. If is_signed is still false, Practitioner finalizes and signs note (changes is_signed to true) before midnight of the current day

### Multi-Patient Management

- Practitioner may have > 1 patients resting simultaneously
- Dashboard shows all active patients with timers
- Easy switching between patient charts
- Notifications when rest time complete

### Documentation Speed Optimization

- Use protocols to populate 10-20 points instantly
- Auto-save drafts continuously
- Templates to help fill out intake more quickly by typing "/[template]"
- Point autocomplete for quick manual entry

## Performance Considerations

### Load Time

- Initial page load should be <2 seconds
- Route transitions should feel instant
- Use Next.js dynamic imports for heavy components

### Data Fetching

- Fetch only data needed for current view
- Cache patient data during active sessions
- Optimistic UI updates for better perceived performance

### Data Caching Strategy (HIPAA-Compliant)

**Client-side caching:**
- Cache only minimum PHI needed for current session
- Encrypt all cached data at rest (device encryption + app-level)
- Clear cache on logout or session timeout
- Never cache sensitive data (SSN, full payment details)
- Cache expiration: 24-48 hours max

**Server-side caching:**
- No PHI in logs or error messages (CloudWatch configured accordingly)
- Cache only anonymized/aggregated data for performance

### Offline Support (Graceful Degradation)

**Approach:** Start with graceful degradation, not full offline-first architecture.

- Show cached data when offline (read-only where possible)
- Queue writes locally (encrypted), sync when online
- **Subscription validation:** Check subscription status on reconnection before syncing
- Grace period for temporary connectivity issues (24-48 hours)
- Show clear "offline mode" indicator to user
- Full offline-first can be enhanced later if needed

### Mobile/Tablet Optimization

- Images optimized for retina displays (2x resolution)
- Touch event handlers, not just click
- Prevent zoom on input focus (for controlled experience)

## Accessibility

### WCAG Compliance

- Maintain color contrast ratios (AA minimum)
- Provide text alternatives for icons
- Ensure keyboard navigation works
- Use semantic HTML

### Touch Accessibility

- 44px minimum touch targets
- Sufficient spacing between tappable elements
- Visual feedback on touch (active states)
- Error messages clear and prominent

## Security & Compliance

### HIPAA Compliance Strategy

**AWS BAA Status:** Signed (covers RDS, S3, Cognito, SNS, SES, CloudWatch, Amplify)

**During Development:**
- Use free/cheap tiers of AWS services
- Build architecture for HIPAA (encryption, audit logs, session timeouts)
- Use only test/mock data (no real PHI)
- Set up code patterns that will be compliant at launch

**At Launch:**
- Enable production encryption keys
- Sign additional BAAs: Stripe, Clearinghouse (if premium tier)
- Begin handling real patient data
- Enable CloudWatch audit logging in production

### Technical Safeguards (Build During Development)

- All patient data encrypted in transit (TLS 1.3) and at rest (RDS encryption, S3 SSE)
- Audit logging for all PHI access via CloudWatch (who, what, when)
- Automatic session timeout after inactivity (Cognito + NextAuth, default 15 min)
- Role-based access control
- MFA support via Cognito

### Administrative Safeguards

- AWS BAA: Signed
- Stripe BAA: Required at launch
- Data backup: RDS automated backups
- Disaster recovery: RDS multi-AZ (if needed)
- Incident response plan (document before launch)

### Physical Safeguards

- AWS infrastructure (SOC 2, HIPAA-eligible)
- No PHI stored on local devices (beyond encrypted cache)
- S3 files accessed via signed URLs (time-limited)

### Data Privacy

- Store only necessary patient information
- Cognito handles password hashing
- JWT tokens with appropriate expiration via NextAuth
- API routes validate authentication
- Data export capability for patients and practitioners

## Analytics & Reporting

### Basic Analytics (Tax Purposes)

- Revenue by day, week, month, year
- Visit counts by period
- Payment method breakdown
- Outstanding balances

### Data Export

- Export all practice data (CSV/JSON)
- Patient data export for patient requests
- Migration support from other EHRs (future: Unified Practice)

## Testing Strategy

### Development Testing

- Manual testing by practitioner (primary user)
- Real-world workflows with actual patients
- Iterate based on friction points discovered

### Future Testing

- Unit tests for utility functions
- Integration tests for critical flows (payment, booking)
- E2E tests for complete user journeys

## Known Constraints

### Browser Support

- Primary: Safari on iPad (iOS 15+)
- Secondary: Chrome, Edge (desktop for admin)
- Mobile: View-first with simple tap-to-edit modal on all modern browsers
- Not targeting: Internet Explorer, old mobile browsers

### Data Limits

- Treatment notes: ~10,000 characters max
- Point protocols: ~50 points max per protocol
- Active patients: ~10 simultaneously (practical limit)

### Future Scalability

- Start with single-practitioner optimization
- Architecture supports multi-practitioner (database ready)
- May need WebSocket for real-time updates for appointment collaboration between front-desk and practitioner, followed by SOAP note collaboration between practitioners later

## Communication Guidelines

### When Asking for Clarification

- Be specific about what's unclear
- Provide options when possible
- Explain trade-offs of different approaches
- Consider the "why" behind requirements

### When Making Suggestions

- Explain reasoning
- Note any assumptions
- Mention alternatives considered
- Highlight potential impacts

### When Something Seems Wrong

- Point out inconsistencies or conflicts
- Suggest corrections
- Explain why it matters
- Don't just silently "fix" it

## Current Development Phase

**Status:** Foundation phase - building app shell and core screens

**Immediate Focus (Phase 1):**

1. Navigation structure and routing
2. Today Screen (dashboard) layout
3. Visual design system implementation
4. Mock data for development
5. Online booking flow (personalized links)

**Phase 2: Core Clinical**

1. Patient management (list, profile, timeline)
2. SOAP note interface
3. Point selection and protocols (with autocomplete)
4. Appointment management

**Phase 3: Payments & Communication**

1. Payment integration (Stripe)
2. SMS notifications (AWS SNS)
3. Email notifications (AWS SES)
4. Treatment packages
5. Superbill generation

**Phase 4+: Advanced Features**

1. AWS Cognito authentication (replace stubbed auth)
2. Insurance billing (clearinghouse integration - premium tier)
3. Advanced analytics
4. Data import from other EHRs (Unified Practice)
5. AI features via AWS Bedrock (smart SOAP notes, pattern suggestions)
6. Protocol sharing marketplace (community feature)

## Resources & References

### Design Inspiration

- Harvey.ai (primary aesthetic reference)
- Modern SaaS dashboards (Linear, Notion)
- Healthcare applications (for professional feel)

### Technical Documentation

- Use [Context7 MCP](https://context7.com/ "Context7 Documentation") for latest documentation first
- [Next.js App Router Docs](https://nextjs.org/docs/app)
- [shadcn/ui Components](https://ui.shadcn.com)
- [Tailwind CSS](https://tailwindcss.com/docs)
- [Prisma 7 ORM](https://www.prisma.io/docs/orm/more/upgrade-guides/upgrading-to-prisma-7)
- [AWS Amplify Hosting](https://docs.aws.amazon.com/amplify/)
- [AWS Cognito](https://docs.aws.amazon.com/cognito/)
- [NextAuth.js v5](https://authjs.dev/)

### Domain Resources

- Acupuncture point database (to be provided by user)
- TCM pattern differentiation
- Standard SOAP note formats
- HIPAA compliance guidelines
- CMS-1500 form requirements (for superbills)

---

## Notes for AI Assistants

### Playwright Browser Issues

If Playwright MCP browser gets stuck with "Browser is already in use" error, kill stale processes:

```bash
pkill -f "mcp-chrome" 2>/dev/null || true; sleep 1
```

Then navigate again with `mcp__playwright__browser_navigate`.

### Working on Features

This project has a clear vision and specific user needs. When working on features:

- Consider the practitioner's workflow and time constraints
- Prioritize ease of use over feature completeness
- Think about touch interaction, not just mouse/keyboard
- Remember the goal: eliminate thinking about software
- **HIPAA compliance architecture from day one** - build patterns that will be compliant, even if not paying for HIPAA plans yet
- **All-AWS stack** - Use AWS services (S3, SNS, SES, etc.) for consistency with BAA
- **Mobile is view-first** - simple tap-to-edit modal for editing, not optimized inline editing
- **Point database will be provided** - prompt user when needed
- **AI is Phase 4+** - Do not plan AI infrastructure now

The practitioner is the primary user and will test everything personally. Real-world usability is the ultimate measure of success.
