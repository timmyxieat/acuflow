# Acuflow - Development Guide

Modern acupuncture EHR SaaS application.

## Project Mission

**Core Philosophy:** "Not having to think about practice management"

- Automate everything (booking, reminders, payments, documentation)
- Make clinical documentation fast and intuitive
- Acupuncture-specific tools (not a generic EHR)

**Target Users:** Solo acupuncture practitioners (expanding to multi-practitioner clinics)

**Primary Device:** iPad in landscape mode, touch-first interface

**Secondary Devices:**
- Desktop browsers for administrative tasks
- Mobile: View-first with tap-to-edit full-screen modal (functional, not optimized)

## Technology Stack

**All-AWS infrastructure** for simplified HIPAA compliance (single BAA).

| Layer | Technology |
|-------|------------|
| Framework | Next.js 16+ with App Router |
| Language | TypeScript |
| Styling | Tailwind CSS |
| UI Components | shadcn/ui |
| Database | PostgreSQL with Prisma 7 ORM |
| Forms | React Hook Form + Zod |
| Animations | Framer Motion |
| Auth | AWS Cognito + NextAuth.js v5 |
| File Storage | AWS S3 (encrypted, signed URLs) |
| SMS/Email | AWS SNS / SES |
| Payments | Stripe |

**Package Policy:** Always use latest stable versions. Check Context7 for current documentation.

## Project Structure

```
/app
  /...authenticated routes
  /login & /signup           # Practitioner auth
  /patient/login             # Patient auth (magic link)
  /book/[clinic-slug]        # Public booking page
  /api                       # Backend API routes
/components
  /ui                        # shadcn/ui components
  /custom                    # Custom components
/lib
  /utils, /hooks, /aws, /db
/data
  /mock-data.ts, /points.ts
/prisma
  /schema.prisma, /migrations, /seed.ts
```

## Key Domain Concepts

**Clinic** → owns Practitioners, Patients, AppointmentTypes, Templates

**Practitioner** → has NPI, license, availability, protocols, appointments

**Patient** → has medical profile (3 layers), conditions, visits, payments

**Appointment** → scheduled → checked_in → in_progress → completed (+ cancelled, no_show)

**Visit** → SOAP note documentation for completed appointments

**Point Protocol** → named collection of acupuncture points with sides and techniques

## Design Principles

- **Touch-optimized:** Minimum 44px tap targets, generous spacing
- **Fast workflows:** Common tasks in seconds, not minutes
- **Professional aesthetic:** Clean, spacious, inspired by Harvey.ai
- Generous whitespace (24-32px between sections)
- 8px rounded corners, muted teal accents on neutral base

## Code Conventions

### General Rules

- Functional components only, TypeScript interfaces for props
- Use `cn()` utility for conditional Tailwind classes
- Touch targets: minimum 44px (`h-11`)
- Prefer `flex gap-*` over individual margins for spacing
- Use left-only padding (`pl-*`) for scrollable areas (scrollbar at right edge)

### File Naming

- Components: `PascalCase.tsx`
- Utilities: `camelCase.ts`
- Pages: Next.js conventions (`page.tsx`, `layout.tsx`)

### Time Formatting (Hydration-Safe)

```typescript
import { formatTime } from '@/lib/dev-time'
formatTime(appointment.scheduledStart) // Returns "9:30 AM"
```

### Prisma Types (IMPORTANT)

Always use Prisma-generated types:

```typescript
// Correct
import type { Patient, Appointment } from '@/generated/prisma/client'
import { AppointmentStatus } from '@/generated/prisma/client'

// Wrong - don't manually define types Prisma generates
```

### Testing CSS Changes

When debugging subtle UI (scrollbars, borders), first apply highly visible styles (bright colors) to verify, then apply final styling.

## Acupuncture Domain Knowledge

### Point Naming

Format: `AB##` (meridian + number)
- Examples: `LI4`, `ST36`, `DU20`
- Meridians: LU, SP, ST, LI, HT, SI, BL, KD, PC, SJ, GB, LV, RN, DU

### Needling Techniques

- **Tonifying:** Strengthening (clockwise, insert slow/remove fast)
- **Reducing:** Draining (counterclockwise, insert fast/remove slow)
- **Even:** Neutral technique
- **None:** No manipulation after insertion

### Point Sides

- **Bilateral / Left / Right / Center** (fixed)
- **Contralateral / Ipsilateral** (dynamic, resolved when protocol applied)

### CPT Codes

| Code | Description |
|------|-------------|
| 97810 | Acupuncture without e-stim, initial 15 min |
| 97811 | Each additional 15 min without e-stim |
| 97813 | Acupuncture with e-stim, initial 15 min |
| 97814 | Each additional 15 min with e-stim |
| 97140 | Manual therapy (tui na, cupping) |

### SOAP Note Format

- **Subjective:** Patient-reported symptoms and history
- **Objective:** Practitioner observations (tongue, pulse, exam)
- **Assessment:** TCM pattern diagnosis + ICD-10 codes
- **Plan:** Treatment approach and points selected

## Development Approach

### Build Philosophy

1. Build screen layouts and navigation first
2. Add basic interactivity and data flow
3. Implement intelligent features
4. Polish and optimize

### Git Commits

- Don't commit after every small change
- Commit when: user asks, feature is finalized, significant work would be lost
- Write clear, descriptive commit messages

### Authentication Strategy

Development uses stubbed user (Dr. Dev). Real Cognito auth added for deployment.

## Security & HIPAA

**Build for HIPAA compliance from day one:**

- All data encrypted in transit (TLS 1.3) and at rest
- Audit logging for PHI access
- Session timeout after inactivity (15 min default)
- Role-based access control
- No PHI in logs or error messages

**AWS BAA:** Signed (covers RDS, S3, Cognito, SNS, SES, CloudWatch, Amplify)

## Notes for AI Assistants

### Feature Tracking

Check `docs/ideas.md` before implementing features. Update status (`[x]`) when completing work. Move completed items to bottom of their section.

### Playwright Browser Issues

If stuck with "Browser is already in use":

```bash
pkill -f "mcp-chrome" 2>/dev/null || true; sleep 1
```

### Working on Features

- Consider the practitioner's workflow and time constraints
- Prioritize ease of use over feature completeness
- Think touch interaction, not just mouse/keyboard
- Goal: eliminate thinking about software
- Mobile is view-first with simple tap-to-edit modal
- Point database will be provided by user
- AI features are Phase 4+ (don't plan now)

The practitioner is the primary user. Real-world usability is the ultimate measure of success.
